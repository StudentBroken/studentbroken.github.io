<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuteur Académique IA (Final)</title>
    <!-- CSS is unchanged and is omitted here for brevity -->
    <style>:root{--user-color:#007bff;--tutor-color:#f1f1f1;--background-color:#ffffff;--text-color:#212529;--border-color:#dee2e6}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;background-color:var(--background-color);color:var(--text-color)}#header{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1.5rem;border-bottom:1px solid var(--border-color);background-color:var(--background-color);flex-shrink:0}#header h1{font-size:1.25rem;margin:0}#status{font-size:.8rem;color:#6c757d}.ai-mode-toggle{display:flex;align-items:center;gap:.5rem}.switch{position:relative;display:inline-block;width:100px;height:34px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--user-color)}input:checked+.slider:before{transform:translateX(66px)}.slider:after{content:'Tuteur';color:white;display:block;position:absolute;transform:translate(-50%,-50%);top:50%;left:30%;font-size:12px}input:checked+.slider:after{content:'Analyste';left:70%}#chat-container{flex-grow:1;padding:1rem 1.5rem;overflow-y:auto;display:flex;flex-direction:column;gap:1rem}.message{padding:10px 18px;border-radius:22px;max-width:80%;line-height:1.5;word-wrap:break-word}.user-message{background-color:var(--user-color);color:white;align-self:flex-end}.tutor-message{background-color:var(--tutor-color);color:var(--text-color);align-self:flex-start}.tutor-message.loading::after{content:'...';display:inline-block;animation:dots 1.5s infinite steps(3,end)}@keyframes dots{0%{content:'.'}33%{content:'..'}66%{content:'...'}}#input-area{display:flex;padding:1rem 1.5rem;border-top:1px solid var(--border-color);background-color:rgba(255,255,255,.8);backdrop-filter:blur(10px)}#user-input{flex-grow:1;border:1px solid #ccc;border-radius:22px;padding:10px 18px;font-size:1rem;resize:none}#send-btn{background-color:var(--user-color);color:white;border:none;border-radius:50%;width:44px;height:44px;margin-left:10px;font-size:1.5rem;cursor:pointer;transition:background-color .2s;display:flex;align-items:center;justify-content:center}#send-btn:disabled{background-color:#a0a0a0;cursor:not-allowed}</style>
</head>
<body>
    <div id="header">
        <div><h1>Extremely smart AI</h1><div id="status">Chargement...</div></div>
        <div class="ai-mode-toggle"><label class="switch"><input type="checkbox" id="ai-mode-checkbox"><span class="slider"></span></label></div>
    </div>
    <div id="chat-container"></div>
    <div id="input-area"><input type="text" id="user-input" placeholder="Posez une question..." disabled><button id="send-btn" disabled>&#9658;</button></div>

    <script type="module">
        // --- THIS IS THE STABLE V3 LOADING SCRIPT ---
        import { pipeline, AutoTokenizer, AutoModelForSeq2SeqLM } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
        
        const status = document.getElementById('status');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const aiModeCheckbox = document.getElementById('ai-mode-checkbox');

        let tutorPipeline = null;
        let studentDataContext = '';
        let currentAiMode = 'tuteur';

        // --- NEW, HYPER-DETAILED PROMPTS ---
        const PROMPT_TUTEUR = `Tu es un tuteur académique expert, amical et encourageant. Ton rôle est de synthétiser les données fournies pour répondre à la question de l'étudiant de manière utile, personnalisée et facile à comprendre.`;
        const PROMPT_ANALYSTE = `Tu es un analyste de données logique et objectif. Ton rôle est d'extraire et de présenter les faits pertinents des données fournies pour répondre à la question de manière factuelle, chiffrée et concise. N'utilise aucun langage émotionnel ou d'opinion.`;
        const BASE_INSTRUCTIONS = `Règles Strictes et Obligatoires:
1. Analyse l'intégralité du CONTEXTE pour trouver les informations pertinentes à la QUESTION.
2. Formule une réponse entièrement nouvelle en utilisant tes propres mots. Ne copie JAMAIS de phrases directement du contexte.
3. Ta réponse doit être une synthèse cohérente, pas une simple liste de données.
4. Si la réponse n'est pas dans le contexte, réponds UNIQUEMENT: "Je n'ai pas cette information dans les données fournies."
5. Sois concis et va droit au but.`;
        // --- END OF NEW PROMPTS ---

        // Helper functions (addMessage, formatDataForSLM) are unchanged
        function addMessage(text, sender) {const messageDiv = document.createElement('div');messageDiv.classList.add('message', `${sender}-message`);messageDiv.textContent = text;chatContainer.appendChild(messageDiv);chatContainer.scrollTop = chatContainer.scrollHeight;return messageDiv;}
        function formatDataForSLM(rawData, analysisData) {let summary = ``;if (rawData?.nom) summary += `Nom de l'étudiant: ${rawData.nom}\n`;['etape1', 'etape2'].forEach(etape => {if (rawData[etape] && rawData[etape].length > 0) {summary += `\n--- RÉSULTATS ${etape.toUpperCase()} ---\n`;rawData[etape].forEach(subject => {summary += `Sujet: ${subject.name} (${subject.code})\n`;subject.competencies.forEach(comp => {comp.assignments.forEach(assign => {if (assign.result) summary += `- Travail: "${assign.work}", Résultat: ${assign.result}\n`;});});});}});if (analysisData) {summary += `\n--- ANALYSE PRÉDICTIVE ---\n`;if(analysisData.globalAverage) summary += `- Moyenne générale (calculée): ${analysisData.globalAverage.toFixed(2)}%\n`;if(analysisData.burnoutRiskScore) summary += `- Score de risque de burnout: ${analysisData.burnoutRiskScore.toFixed(0)}/100\n`;if(analysisData.globalConsistencyScore) summary += `- Indice de consistance: ${analysisData.globalConsistencyScore.toFixed(0)}/100\n`;if(analysisData.predictions?.global?.p50) summary += `- Prédiction de la moyenne finale: ${analysisData.predictions.global.p50.toFixed(2)}%\n`;}return summary;}

        async function handleSend() {
            const query = userInput.value.trim();
            if (query === '' || !tutorPipeline) return;
            addMessage(query, 'user');
            userInput.value = '';
            
            const loadingMessage = addMessage("Réflexion en cours...", 'tutor');
            loadingMessage.classList.add('loading');
            
            const personalityPrompt = currentAiMode === 'tuteur' ? PROMPT_TUTEUR : PROMPT_ANALYSTE;
            
            // This is the improved prompt that forces the AI to be smart
            const fullPrompt = `TÂCHE:\n${personalityPrompt}\n${BASE_INSTRUCTIONS}\n\nCONTEXTE:\n---\n${studentDataContext}\n---\n\nQUESTION:\n"${query}"\n\nRÉPONSE SYNTHÉTISÉE:`;

            try {
                const result = await tutorPipeline(fullPrompt, {
                    max_new_tokens: 300,
                    temperature: 0.7,
                    top_k: 50,
                    do_sample: true,
                });
                loadingMessage.textContent = result[0].generated_text;
                loadingMessage.classList.remove('loading');
            } catch (e) {
                loadingMessage.textContent = "Désolé, une erreur est survenue.";
                console.error("Inference error:", e);
            }
        }

        async function main() {
            try {
                const rawData = JSON.parse(localStorage.getItem('mbsData'));
                if (!rawData?.valid) { status.textContent = "Données 'mbsData' introuvables."; return; }
                studentDataContext = formatDataForSLM(rawData, JSON.parse(localStorage.getItem('mbsProjectionCache')));

                // This is the model from the version that WORKED.
                const model_id = 'Xenova/LaMini-Flan-T5-77M';
                const task = 'text2text-generation';
                
                // --- WE USE THE STABLE MANUAL ASSEMBLY PROCESS THAT WORKED ---
                status.textContent = "Étape 1/3 : Chargement du tokenizer...";
                const tokenizer = await AutoTokenizer.from_pretrained(model_id);

                status.textContent = "Étape 2/3 : Chargement du modèle principal...";
                // This is the loading function that WORKED.
                const model = await AutoModelForSeq2SeqLM.from_pretrained(model_id, {
                    quantized: true, // Ask for the small version
                    progress_callback: (p) => {
                        // This robust callback handles all status updates without crashing.
                        if (p.file) {
                            status.textContent = `Chargement... (${p.file.split('/').pop()}: ${Math.round(p.progress)}%)`;
                        } else if (p.status) {
                            status.textContent = `Chargement... (${p.status}: ${Math.round(p.progress)}%)`;
                        }
                    }
                });

                status.textContent = "Étape 3/3 : Assemblage du pipeline...";
                tutorPipeline = await pipeline(task, model, { tokenizer });
                
                status.textContent = `Bonjour, ${rawData.nom}! Je suis prêt.`;
                userInput.disabled = false;
                sendBtn.disabled = false;
                addMessage(`J'ai analysé vos données. Comment puis-je vous aider aujourd'hui ?`, 'tutor');

            } catch (e) {
                status.textContent = "Erreur critique. Vérifiez la console (F12).";
                console.error("CRITICAL ERROR in main():", e);
            }
        }

        // Event listeners are unchanged
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
        aiModeCheckbox.addEventListener('change', (e) => {
            currentAiMode = e.target.checked ? 'analyste' : 'tuteur';
        });
        
        main();
    </script>
</body>
</html>
