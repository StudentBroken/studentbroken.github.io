<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant IA Fiable - Outil MBS</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- The CSS is unchanged from your friend's version -->
    <style>:root{--transition-duration:0.15s;--primary-color:#2980b9;--secondary-color:#2c3e50;--background-color:#f7f9fb;--widget-background:#ffffff;--text-color:#34495e;--light-grey:#bdc3c7;--footer-grey:#7f8c8d;--danger-color:#e74c3c;--shadow:0 8px 15px rgba(0,0,0,.08);--border-color:#e0e6eb}[data-theme='dark']{--background-color:#121212;--widget-background:#1e1e1e;--text-color:#e0e0e0;--secondary-color:#bbb;--light-grey:#757575;--footer-grey:#a0a0a0;--danger-color:#ff6b6b;--shadow:0 8px 20px rgba(0,0,0,.4);--border-color:#333}body, .site-header-container, .data-widget, textarea, .icon-btn, footer, .chat-input-area, #send-chat-btn, #chat-input{transition:background-color var(--transition-duration) ease,color var(--transition-duration) ease,border-color var(--transition-duration) ease,box-shadow var(--transition-duration) ease}body{margin:0;font-family:'Inter',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:var(--background-color);color:var(--text-color);display:flex;flex-direction:column;min-height:100vh}.site-header-container{background-color:var(--widget-background);box-shadow:0 2px 4px rgba(0,0,0,.05);padding:15px 25px;position:relative;display:flex;align-items:center;justify-content:space-between}.header-left,.header-right{display:flex;align-items:center;gap:15px}.site-header{text-align:center;padding:0;margin:0;color:var(--secondary-color);font-size:2.2em;font-weight:700;font-family:'Playfair Display',serif;position:absolute;left:50%;transform:translateX(-50%)}.content{flex-grow:1;display:flex;justify-content:center;align-items:flex-start;padding:40px 20px}.icon-btn{background:none;border:2px solid var(--light-grey);color:var(--text-color);width:40px;height:40px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1em;text-decoration:none;transition:all .2s ease,background-color var(--transition-duration),box-shadow .2s}.icon-btn:hover{border-color:var(--primary-color);color:var(--primary-color);transform:scale(1.1)}.data-widget{background-color:var(--widget-background);padding:40px;border-radius:16px;box-shadow:var(--shadow);width:100%;max-width:650px;text-align:center}footer{text-align:center;padding:25px;font-size:.9em;color:var(--footer-grey);border-top:1px solid var(--border-color);margin-top:auto}#chat-messages{height:400px;overflow-y:auto;border:1px solid var(--border-color);border-radius:10px;padding:15px;margin-bottom:20px;display:flex;flex-direction:column;text-align:left;background-color:var(--background-color)}.message{max-width:80%;padding:10px 15px;border-radius:15px;margin-bottom:10px;word-wrap:break-word;line-height:1.4}.user-message{background-color:var(--primary-color);color:white;align-self:flex-end;border-bottom-right-radius:3px}.assistant-message{background-color:#e0e6eb;color:#2c3e50;align-self:flex-start;border-bottom-left-radius:3px}[data-theme='dark'] .assistant-message {background-color: #3a3a3a; color: #e0e0e0;}.status-message{color:var(--footer-grey);font-style:italic;text-align:center;margin:10px 0;align-self:center}.chat-input-area{display:flex;gap:10px}#chat-input{flex-grow:1;padding:12px;border:2px solid var(--border-color);border-radius:10px;font-size:1em;background-color:var(--background-color);color:var(--text-color)}#chat-input:focus{border-color:var(--primary-color);outline:none}#send-chat-btn,#start-ai-btn{width:auto;padding:12px 20px;background-color:var(--primary-color);color:white;border:none;border-radius:10px;font-size:1em;font-weight:bold;cursor:pointer;transition:background-color .3s}#send-chat-btn:hover:not(:disabled),#start-ai-btn:hover:not(:disabled){background-color:#2471a3}#send-chat-btn:disabled,#start-ai-btn:disabled{background-color:var(--light-grey);cursor:not-allowed}</style>
</head>
<body>
    <header class="site-header-container">
        <div class="header-left"><a href="#" class="icon-btn" title="Retour"><i class="fa-solid fa-arrow-left"></i></a></div>
        <h1 class="site-header">Outil MBS</h1>
        <div class="header-right"><button class="icon-btn" id="theme-toggle" title="Mode Sombre/Clair"><i class="fa-solid fa-moon"></i></button><button class="icon-btn" title="Aide"><i class="fa-solid fa-circle-question"></i></button></div>
    </header>
    <main class="content">
        <div class="data-widget" id="data-widget">
            <h2 style="font-family: 'Playfair Display', serif; font-weight: 700;">Assistant IA Fiable</h2>
            <p style="margin-top: -10px; margin-bottom: 30px;">Ce chatbot a accès aux données de l'étudiant.</p>
            <div id="chatbot-container">
                <div id="chat-messages"><div class="status-message" id="initial-status">Cliquez pour démarrer l'assistant IA.<br><small id="model-download-size"></small></div></div>
                <button id="start-ai-btn">Démarrer l'Assistant</button>
                <div class="chat-input-area" id="chat-input-wrapper" style="display: none;"><input type="text" id="chat-input" placeholder="Chargement..." disabled><button id="send-chat-btn" disabled>Envoyer</button></div>
            </div>
        </div>
    </main>
    <footer><p>Outil MBS - Moyenne, Bilan, Stratégie</p></footer>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
        env.allowRemoteModels = true;

        const themeToggleBtn = document.getElementById('theme-toggle');
        const html = document.documentElement;
        const toggleIcon = themeToggleBtn.querySelector('i');
        const THEME_KEY = 'mbs-theme';
        const updateTheme = (theme) => { html.setAttribute('data-theme', theme); localStorage.setItem(THEME_KEY, theme); toggleIcon.classList.toggle('fa-sun', theme === 'dark'); toggleIcon.classList.toggle('fa-moon', theme !== 'dark'); };
        const storedTheme = localStorage.getItem(THEME_KEY);
        const initialTheme = storedTheme || (window.matchMedia?.matches ? 'dark' : 'light');
        updateTheme(initialTheme);
        themeToggleBtn.addEventListener('click', () => { const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; updateTheme(newTheme); });

        let generator = null;
        let studentDataContext = '';
        let chatHistory = [];

        // --- THE LIGHTWEIGHT, CHROMEBOOK-FRIENDLY MODEL ---
        const CHAT_MODEL = 'MBZUAI/LaMini-GPT-124M';
        const CHAT_TASK = 'text-generation';
        document.getElementById('model-download-size').textContent = '(Téléchargement unique d\'environ 480MB)';

        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-chat-btn');
        const messagesContainer = document.getElementById('chat-messages');
        const startBtn = document.getElementById('start-ai-btn');
        const chatInputWrapper = document.getElementById('chat-input-wrapper');

        async function initializeChatbot() {
            startBtn.style.display = 'none';
            chatInputWrapper.style.display = 'flex';
            addMessageToChat('Chargement des données de l\'étudiant...', 'status');

            try {
                const rawData = JSON.parse(localStorage.getItem('mbsData'));
                const analysisData = JSON.parse(localStorage.getItem('mbsProjectionCache'));
                if (!rawData?.valid) { addMessageToChat("Erreur : Données 'mbsData' introuvables.", 'status'); return; }
                studentDataContext = formatDataForSLM(rawData, analysisData);
                addMessageToChat('Données chargées. Téléchargement du modèle IA...', 'status');
            } catch (e) { addMessageToChat(`Erreur (données locales) : ${e.message}`, 'status'); return; }
            
            try {
                generator = await pipeline(CHAT_TASK, CHAT_MODEL, {
                    quantized: true,
                    progress_callback: (p) => {
                        const statusMessage = messagesContainer.querySelector('.status-message:last-child');
                        if (statusMessage) statusMessage.textContent = `Chargement : ${p.file} (${Math.round(p.progress)}%)`;
                    }
                });
                
                // Set up the initial conversation context
                const personalityPrompt = `Tu es un tuteur académique expert, amical et encourageant.`;
                chatHistory = [`System: ${personalityPrompt} ${studentDataContext}`];
                
                messagesContainer.querySelector('.status-message:last-child')?.remove();
                addMessageToChat('Bonjour ! Je suis l\'Assistant MBS. J\'ai analysé vos données. Posez-moi une question.', 'assistant');
                chatInput.disabled = false; sendBtn.disabled = false;
                chatInput.placeholder = 'Écrivez votre message...'; chatInput.focus();
            } catch (error) {
                addMessageToChat(`Erreur critique (modèle IA) : ${error.message}`, 'status');
                console.error("Model loading error:", error);
            }
        }

        async function handleChatSubmit() {
            const userMessage = userInput.value.trim();
            if (!userMessage || !generator) return;
            addMessageToChat(userMessage, 'user');
            chatInput.value = ''; chatInput.disabled = true; sendBtn.disabled = true;
            const typingIndicator = addMessageToChat("L'assistant réfléchit...", 'assistant status-message');
            
            chatHistory.push(`User: ${userMessage}`);
            const prompt = chatHistory.join('\n') + '\nAssistant:';
            
            const result = await generator(prompt, { max_new_tokens: 256, temperature: 0.7, top_k: 50 });
            const assistantResponse = result[0].generated_text.split(prompt).pop().trim();
            
            typingIndicator.remove();
            addMessageToChat(assistantResponse, 'assistant');
            chatHistory.push(`Assistant: ${assistantResponse}`);
            if (chatHistory.length > 8) chatHistory = chatHistory.slice(-8);

            chatInput.disabled = false; sendBtn.disabled = false; chatInput.focus();
        }
        
        function formatDataForSLM(rawData, analysisData) {
            let summary = `Tu as accès aux données académiques suivantes pour un étudiant nommé ${rawData.nom || 'l\'étudiant'}.\n\n`;
            ['etape1', 'etape2'].forEach(etape => {
                if (rawData[etape] && rawData[etape].length > 0) {
                    summary += `--- RÉSULTATS ${etape.toUpperCase()} ---\n`;
                    rawData[etape].forEach(subject => {
                        summary += `Sujet: ${subject.name} (${subject.code})\n`;
                        subject.competencies.forEach(comp => {
                            comp.assignments.forEach(assign => {
                                if (assign.result) summary += `- Travail: "${assign.work}", Résultat: ${assign.result}\n`;
                            });
                        });
                    });
                }
            });
            if (analysisData) {
                summary += `\n\n--- ANALYSE PRÉDICTIVE ---\n`;
                if(analysisData.globalAverage) summary += `- Moyenne générale (calculée): ${analysisData.globalAverage.toFixed(2)}%\n`;
                if(analysisData.burnoutRiskScore) summary += `- Score de risque de burnout: ${analysisData.burnoutRiskScore.toFixed(0)}/100\n`;
                if(analysisData.globalConsistencyScore) summary += `- Indice de consistance: ${analysisData.globalConsistencyScore.toFixed(0)}/100\n`;
                if(analysisData.predictions?.global?.p50) summary += `- Prédiction de la moyenne finale: ${analysisData.predictions.global.p50.toFixed(2)}%\n`;
            }
            return summary;
        }

        function addMessageToChat(text, role) {
            const messageDiv = document.createElement('div');
            if (role === 'status' && messagesContainer.querySelector('#initial-status')) {
                messagesContainer.querySelector('#initial-status').style.display = 'none';
            }
            messageDiv.className = `message ${role}-message`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageDiv;
        }

        startBtn.onclick = initializeChatbot;
        sendBtn.onclick = handleChatSubmit;
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleChatSubmit(); } });
    </script>
</body>
</html>
