<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse - Outil MBS</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>

    <style>
        :root {
            --primary-color: #2980b9; --secondary-color: #2c3e50; --background-color: #f7f9fb; --widget-background: #ffffff; --text-color: #34495e; --text-secondary-color: #7f8c8d; --accent-color: #3498db; --light-grey: #e0e6eb; --footer-grey: #7f8c8d; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --shadow-header: 0 2px 4px rgba(0,0,0,0.05); --shadow-widget: 0 8px 15px rgba(0,0,0,0.08); --border-color: #e0e6eb; --goal-success-bg: #eafaf1; --goal-warning-bg: #fff9f0; --goal-danger-bg: #fdf3f2; --transition-duration: 0.35s;
        }
        [data-theme="dark"] {
            --background-color: #121212; --widget-background: #1e1e1e; --text-color: #e0e0e0; --text-secondary-color: #a0a0a0; --secondary-color: #bbbbbb; --light-grey: #333333; --footer-grey: #a0a0a0; --shadow-header: 0 2px 5px rgba(255,255,255,0.1); --shadow-widget: 0 5px 10px rgba(0,0,0,0.3); --border-color: #333333; --goal-success-bg: #1a3e2a; --goal-warning-bg: #4d381c; --goal-danger-bg: #4f2323;
        }
        [data-theme="dark"] .site-header,[data-theme="dark"] .widget-title { color:var(--text-color); } [data-theme="dark"] .comp-widget,[data-theme="dark"] .calculator-container { background-color:#282828; border-color:var(--border-color); } [data-theme="dark"] .modal-content { background-color:var(--background-color); } [data-theme="dark"] .modal-header { background-color:#2c3e50; } [data-theme="dark"] .goal-input input { background-color:#282828; border-color:var(--light-grey); color:var(--text-color); } [data-theme="dark"] #order-list li { background-color:#333; } [data-theme="dark"] .grade-pill { background-color:#444; } [data-theme="dark"] .leaderboard-item.is-user { background-color: #2c3e50; }

        body, .site-header-container, .subject-widget, .tab-btn { transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease, border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); }
        .site-header-container { background-color: var(--widget-background); box-shadow: var(--shadow-header); border-bottom: 1px solid var(--border-color); padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; flex: 1; }
        .header-right { justify-content: flex-end; }
        .site-header { flex: 2; text-align: center; padding: 0; margin: 0; color: var(--secondary-color); font-size: 2.2em; font-family: 'Playfair Display', serif; }
        .icon-btn { background: none; border: 2px solid var(--light-grey); color: var(--text-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1em; text-decoration: none; transition: all 0.2s ease; }
        .icon-btn:hover { border-color: var(--primary-color); color: var(--primary-color); transform: scale(1.1); }
        .btn-secondary { text-decoration: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; background-color: #2980b9; color: white; border: none; transition: all 0.2s ease; }
        .btn-secondary:hover { background-color: #3498db; }
        .sticky-tabs { position: sticky; top: 0; background-color: var(--background-color); z-index: 100; padding: 15px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: 1px solid var(--light-grey); border-radius: 20px; background-color: transparent; color: var(--text-color); font-weight: 600; cursor: pointer; }
        .tab-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .widget-grid { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px; }
        .subject-widget { background-color: var(--widget-background); border-radius: 12px; box-shadow: var(--shadow-widget); padding: 20px; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
        .subject-widget:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }
        .widget-top-section { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; cursor: pointer; }
        .widget-info { flex: 1; }
        .widget-title { font-size: 1.2em; font-weight: 700; color: var(--secondary-color); margin: 0 0 10px 0; }
        .widget-average { font-size: 2.5em; font-weight: 700; color: var(--primary-color); margin: 0; }
        .widget-trend { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.9em; margin-top: 5px; }
        .widget-trend.up { color: var(--success-color); } .widget-trend.down { color: var(--danger-color); } .widget-trend.neutral { color: var(--text-secondary-color); }
        .gauge-container, .histogram-container { margin-top: 15px; height: 120px; }
        .widget-chart-controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; height: 25px; gap: 5px; }
        .chart-toggle-btn { background: none; border: 1px solid var(--border-color); color: var(--light-grey); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8em; }
        .chart-toggle-btn:hover { color: var(--primary-color); border-color: var(--primary-color); }
        #expanded-view-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 20px; box-sizing: border-box; }
        #expanded-view-overlay.active { opacity: 1; visibility: visible; }
        #expanded-view-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; width: 100%; max-width: 1400px; max-height: 95vh; }
        #expanded-view-grid .subject-widget { transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #expanded-view-overlay.active .subject-widget { transform: scale(1); }
        #expanded-view-grid .subject-widget { cursor: default; } #expanded-view-grid .widget-top-section { cursor: default; } #expanded-view-grid .subject-widget:hover { transform: translateY(0); box-shadow: var(--shadow-widget); }
        .details-widget-body { height: calc(95vh - 120px); overflow-y: auto; padding-right: 10px; }
        .competency-widgets { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .comp-widget { flex: 1; min-width: 150px; background-color: var(--widget-background); border-radius: 8px; padding: 15px; text-align: center; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
        .comp-widget.active { border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color); }
        .calculator-container { background-color: var(--widget-background); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color); margin-top: 25px; }
        .goal-input { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .goal-input input { width: 80px; padding: 8px; border-radius: 6px; border: 1px solid var(--light-grey); text-align: center; font-size: 1.1em; }
        .goal-result { padding: 15px; border-radius: 6px; text-align: center; font-size: 1.1em; font-weight: 600; }
        .goal-result.success { background-color: var(--goal-success-bg); color: var(--success-color); } .goal-result.warning { background-color: var(--goal-warning-bg); color: var(--warning-color); } .goal-result.danger { background-color: var(--goal-danger-bg); color: var(--danger-color); }
        .btn-save { padding: 8px 12px; border: none; background-color: var(--primary-color); color: white; border-radius: 6px; cursor: pointer; }
        .mini-leaderboard-container { flex-grow: 1; overflow-y: auto; position: relative; border-top: 1px solid var(--light-grey); padding-top: 15px; max-height: 250px; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 8px 10px; border-radius: 8px; font-size: 0.9em; transition: background-color 0.2s; }
        .leaderboard-item.is-user { background-color: #eaf2f8; font-weight: bold; }
        .item-rank { width: 40px; } .item-name { flex-grow: 1; } .item-grade { font-weight: 600; }
        .widget-rank { font-size: 1.1em; color: var(--secondary-color); margin-top: 5px; }
        @keyframes ghost-loading { 0% { background-color: rgba(128, 128, 128, 0.1); } 50% { background-color: rgba(128, 128, 128, 0.2); } 100% { background-color: rgba(128, 128, 128, 0.1); } }
        .ghost-item { animation: ghost-loading 1.5s infinite ease-in-out; background-color: var(--light-grey); border-radius: 8px; height: 38px; margin-bottom: 8px; }
        footer { text-align: center; padding: 25px; font-size: 0.9em; color: var(--footer-grey); border-top: 1px solid var(--border-color); margin-top: 40px; }
        
        /* Chatbot Styles */
        :root { --mbs-bg-color: #1a1a1a; --mbs-surface-color: #2c2c2c; --mbs-primary-color: #61afef; --mbs-text-color: #f0f0f0; --mbs-text-secondary-color: #a0a0a0; --mbs-border-color: #444444; --mbs-font-family: 'Inter', sans-serif; }
        #mbs-chatbot-container *, #mbs-chatbot-container *::before, #mbs-chatbot-container *::after { box-sizing: border-box; margin: 0; padding: 0; }
        #mbs-chatbot-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; font-family: var(--mbs-font-family); }
        #mbs-chatbot-toggle { position: relative; z-index: 10000; background-color: var(--mbs-primary-color); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.2s ease; }
        #mbs-chatbot-container.expanded #mbs-chatbot-toggle { transform: translateX(calc(-1 * clamp(400px, 50vw, 800px))); }
        #mbs-chatbot-toggle.loading { background-color: #444; cursor: wait; animation: mbs-pulse 1.5s infinite; }
        #mbs-chatbot-toggle:not(.loading):hover { transform: scale(1.1); }
        #mbs-chatbot-toggle .chat-icon, #mbs-chatbot-toggle .close-icon, #mbs-chatbot-toggle .loading-icon { display: none; }
        #mbs-chatbot-toggle:not(.loading) .chat-icon { display: block; }
        #mbs-chatbot-container.expanded #mbs-chatbot-toggle .chat-icon { display: none; } #mbs-chatbot-container.expanded #mbs-chatbot-toggle .close-icon { display: block; }
        #mbs-chatbot-toggle.loading .loading-icon { display: block; animation: mbs-spin 1.5s linear infinite; }
        @keyframes mbs-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes mbs-pulse { 0% { box-shadow: 0 0 0 0 rgba(97, 175, 239, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(97, 175, 239, 0); } 100% { box-shadow: 0 0 0 0 rgba(97, 175, 239, 0); } }
        #mbs-chatbot-window { position: fixed; top: 0; right: 0; bottom: 0; width: clamp(400px, 50vw, 800px); height: 100%; background-color: var(--mbs-bg-color); border-left: 1px solid var(--mbs-border-color); box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; transform: translateX(100%); pointer-events: none; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 9999; }
        #mbs-chatbot-container.expanded #mbs-chatbot-window { transform: translateX(0); pointer-events: auto; }
        .mbs-chat-header { padding: 16px; background-color: var(--mbs-surface-color); border-bottom: 1px solid var(--mbs-border-color); text-align: center; flex-shrink: 0; }
        .mbs-chat-header h3 { color: var(--mbs-text-color); font-size: 1.25rem; margin: 0; }
        #mbs-chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        #mbs-chat-messages a { color: var(--mbs-primary-color); text-decoration: underline;}
        #mbs-chat-messages::-webkit-scrollbar { width: 6px; } #mbs-chat-messages::-webkit-scrollbar-track { background: transparent; } #mbs-chat-messages::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
        .mbs-chat-message { max-width: 90%; padding: 12px 18px; border-radius: 12px; line-height: 1.6; font-size: 1rem; overflow-wrap: break-word; }
        .mbs-chat-message.user { background-color: var(--mbs-primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .mbs-chat-message.ai { background-color: var(--mbs-surface-color); color: var(--mbs-text-color); align-self: flex-start; border-bottom-left-radius: 4px; }
        .mbs-chat-message.ai * { margin: 0; color: inherit; } .mbs-chat-message.ai > *:not(:last-child) { margin-bottom: 0.8em; }
        .mbs-chat-message.ai ul, .mbs-chat-message.ai ol { padding-left: 25px; } .mbs-chat-message.ai li { margin-bottom: 4px; }
        .mbs-chat-message.ai strong, .mbs-chat-message.ai b { color: #e5c0ff; font-weight: 600; }
        .mbs-typing-indicator { align-self: flex-start; display: flex; align-items: center; gap: 5px; padding: 14px 20px; background-color: var(--mbs-surface-color); border-radius: 12px; border-bottom-left-radius: 4px; }
        .mbs-typing-indicator span { width: 8px; height: 8px; background-color: var(--mbs-text-secondary-color); border-radius: 50%; animation: mbs-typing-bounce 1.4s infinite ease-in-out both; }
        .mbs-typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .mbs-typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes mbs-typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        #mbs-chat-form { display: flex; padding: 16px; border-top: 1px solid var(--mbs-border-color); background-color: var(--mbs-surface-color); flex-shrink: 0; }
        #mbs-chat-form:has(input:disabled) #mbs-chat-input { background-color: #383838; cursor: not-allowed; } #mbs-chat-form:has(input:disabled) #mbs-chat-send { background-color: #555; cursor: not-allowed; }
        #mbs-chat-input { flex-grow: 1; background-color: var(--mbs-bg-color); border: 1px solid var(--mbs-border-color); border-radius: 20px; padding: 12px 18px; color: var(--mbs-text-color); font-size: 1rem; margin-right: 10px; outline: none; transition: border-color 0.2s ease; }
        #mbs-chat-input:focus { border-color: var(--mbs-primary-color); } #mbs-chat-input::placeholder { color: var(--mbs-text-secondary-color); }
        #mbs-chat-send { background-color: var(--mbs-primary-color); border: none; color: white; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; transition: background-color 0.2s ease; }
        #mbs-chat-send:not([disabled]):hover { background-color: #9b78e3; }
        @media (max-width: 500px) { #mbs-chatbot-window { width: 100vw; } #mbs-chatbot-container { bottom: 10px; right: 10px; } }
    </style>
</head>
<body>
    <header class="site-header-container">
        <div class="header-left">
            <a href="main.html" class="icon-btn" title="Retour au tableau de bord"><i class="fa-solid fa-arrow-left"></i></a>
        </div>
        <h1 class="site-header">Outil MBS</h1>
        <div class="header-right">
            <button id="theme-toggle" class="icon-btn" aria-label="Changer de thème"><i class="fa-solid fa-moon"></i></button>
            <a href="projection.html" class="btn-secondary">Projection</a>
        </div>
    </header>

    <div class="sticky-tabs">
        <button class="tab-btn active" data-etape="generale">Générale</button>
        <button class="tab-btn" data-etape="etape1">Étape 1</button>
        <button class="tab-btn" data-etape="etape2">Étape 2</button>
        <button class="tab-btn" data-etape="etape3">Étape 3</button>
    </div>

    <main id="widget-grid" class="widget-grid"></main>
    
    <div id="expanded-view-overlay">
        <div id="expanded-view-grid"></div>
    </div>

    <div id="mbs-chatbot-container">
        <div id="mbs-chatbot-window">
            <div class="mbs-chat-header"><h3>Assistant MBS</h3></div>
            <div id="mbs-chat-messages"></div>
            <form id="mbs-chat-form">
                <input type="text" id="mbs-chat-input" placeholder="Chargement de l'assistant..." autocomplete="off" disabled>
                <button type="submit" id="mbs-chat-send" aria-label="Envoyer" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(45deg); margin-left: -2px;"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                </button>
            </form>
        </div>
        <button id="mbs-chatbot-toggle" aria-label="Ouvrir/Fermer le chatbot" class="loading">
            <span class="chat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span>
            <span class="close-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span>
            <span class="loading-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg></span>
        </button>
    </div>

    <footer><p>Outil MBS - Moyenne, Bilan, Stratégie</p></footer>

<script>
    // ===================================================================================
    // MAIN PAGE LOGIC (IMPROVE-FUNCTIONS.JS)
    // ===================================================================================
    (function() {
        // Ensure the script runs after the document is fully loaded
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element References ---
            const widgetGrid = document.getElementById('widget-grid');
            const tabs = document.querySelectorAll('.tab-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const chartInstances = {}; // To keep track of Chart.js instances

            // --- Data Retrieval ---
            // FIX #1: Data is now fetched fresh from localStorage inside rendering functions
            // to ensure it's always up-to-date.
            const getMbsData = () => JSON.parse(localStorage.getItem('mbsData') || '{}');

            // --- Core Calculation Logic ---
            // FIX #4: Centralized average calculation. All parts of the app use this function.
            const calculateAverage = (grades, etape = 'generale') => {
                const relevantGrades = etape === 'generale' 
                    ? grades 
                    : grades.filter(g => g.etape === etape);

                if (relevantGrades.length === 0) return { average: null, totalWeight: 0 };

                let totalWeightedScore = 0;
                let totalWeight = 0;

                relevantGrades.forEach(grade => {
                    const score = parseFloat(grade.resultat);
                    const weight = parseFloat(grade.ponderation);
                    if (!isNaN(score) && !isNaN(weight) && weight > 0) {
                        totalWeightedScore += score * weight;
                        totalWeight += weight;
                    }
                });

                if (totalWeight === 0) return { average: null, totalWeight: 0 };
                
                const average = (totalWeightedScore / totalWeight);
                return { average: Math.round(average * 10) / 10, totalWeight };
            };
            
            // --- UI Rendering ---
            const renderWidgets = (etape = 'generale') => {
                const data = getMbsData();
                widgetGrid.innerHTML = ''; // Clear existing widgets
                
                if (!data.subjects) {
                    widgetGrid.innerHTML = '<p>Aucune donnée à afficher. Veuillez importer vos notes.</p>';
                    return;
                }

                data.subjects.forEach(subject => {
                    const { average } = calculateAverage(subject.grades, etape);
                    
                    const widget = document.createElement('div');
                    widget.className = 'subject-widget';
                    widget.dataset.subjectId = subject.name; // Use name as a unique ID for now

                    widget.innerHTML = `
                        <div class="widget-top-section">
                            <div class="widget-info">
                                <h3 class="widget-title">${subject.name}</h3>
                                <p class="widget-average">${average !== null ? average + '%' : 'N/A'}</p>
                                <div class="widget-trend neutral">
                                    <i class="fa-solid fa-minus"></i> Tendance Stable
                                </div>
                            </div>
                            <div class="gauge-container">
                                <!-- Gauge/Ranking can be added here -->
                            </div>
                        </div>
                        <div class="histogram-container">
                            <canvas id="chart-${subject.name.replace(/\s/g, '-')}-${etape}"></canvas>
                        </div>
                    `;
                    widgetGrid.appendChild(widget);

                    // --- Chart Rendering ---
                    const canvasId = `chart-${subject.name.replace(/\s/g, '-')}-${etape}`;
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    
                    const relevantGrades = (etape === 'generale' ? subject.grades : subject.grades.filter(g => g.etape === etape))
                        .map(g => g.resultat)
                        .filter(g => g !== null && !isNaN(g));
                    
                    // Destroy previous chart instance if it exists to prevent memory leaks
                    if (chartInstances[canvasId]) {
                        chartInstances[canvasId].destroy();
                    }

                    chartInstances[canvasId] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: relevantGrades.map((_, i) => `Éval ${i + 1}`),
                            datasets: [{
                                label: 'Résultats',
                                data: relevantGrades,
                                backgroundColor: 'rgba(41, 128, 185, 0.6)',
                                borderColor: 'rgba(41, 128, 185, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 100 }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                });
            };

            // --- Event Listeners ---
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderWidgets(tab.dataset.etape);
                });
            });

            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'dark') {
                    document.documentElement.removeAttribute('data-theme');
                    themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
                } else {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
                }
            });

            // --- Initial Load ---
            renderWidgets('generale'); // Initial render on page load
        });
    })();

    // ===================================================================================
    // CHATBOT LOGIC
    // ===================================================================================
    (function() {
        const appScriptUrl = "https://script.google.com/macros/s/AKfycbwSKlEFJU94tw8B0Vq1VB4dI-4fgD1whUl4IoFkkelrODBjPdIGh3jTOYgIMR-cu5WIcg/exec";
        const GEMINI_MODEL = "gemini-1.5-flash-latest"; // Using a common, reliable model
        let geminiApiKey = '';
        let isFetching = false;
        let conversationHistory = []; // To maintain context

        // FIX #2 & #5: Enhanced system prompt for better instructions, links, and context awareness.
        const SYSTEM_PROMPT = `Tu es "Assistant MBS", un assistant IA pour les élèves du système éducatif québécois. Ton but est de les aider à comprendre leurs notes, à identifier leurs forces et faiblesses, et à trouver des stratégies pour s'améliorer.
        
        **Instructions Clés :**
        1.  **Langue :** Communique en français (par défaut) ou en anglais, selon la langue de l'utilisateur.
        2.  **Concision :** Sois direct et concis. Pour une simple salutation, réponds simplement. Ne fournis une analyse détaillée que si l'utilisateur le demande.
        3.  **Mise en Forme (CRUCIAL) :** Utilise le format Markdown pour la lisibilité. Sépare les idées en paragraphes (double saut de ligne). Utilise des listes à puces (\`*\`) et du texte en gras (\`**texte**\`) pour structurer tes réponses. Évite les longs blocs de texte compact.
        4.  **Ressources Externes :** Lorsque c'est pertinent, fournis des liens cliquables vers des ressources utiles. Propose **systématiquement** des liens vers [Alloprof](https://www.alloprof.qc.ca) pour l'aide aux devoirs et [Google Classroom](https://classroom.google.com/) pour l'organisation. Tu peux aussi suggérer d'autres outils comme des applications de planification.
        5.  **Analyse des Données :** Les données académiques de l'élève sont fournies ci-dessous en format JSON. Utilise ces données pour répondre précisément aux questions sur ses notes, ses moyennes et ses projections. Fais référence aux matières et aux notes spécifiques lorsque tu donnes des conseils.
        `;

        const container = document.getElementById('mbs-chatbot-container');
        const toggleButton = document.getElementById('mbs-chatbot-toggle');
        const messagesContainer = document.getElementById('mbs-chat-messages');
        const chatForm = document.getElementById('mbs-chat-form');
        const chatInput = document.getElementById('mbs-chat-input');
        const chatSend = document.getElementById('mbs-chat-send');

        function init() {
            // FIX #3: Configure marked to treat single newlines as <br>, fixing spacing issues.
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false // Set to true if you need to sanitize user-generated markdown
            });
            setChatState('loading');
            fetchApiKey();
            setupEventListeners();
        }

        function setChatState(state) {
            isFetching = (state === 'fetching');
            const isReady = (state === 'ready' || state === 'idle');
            toggleButton.classList.toggle('loading', state === 'loading' || state === 'fetching');
            chatInput.disabled = !isReady;
            chatSend.disabled = !isReady;

            if (state === 'ready') {
                chatInput.placeholder = "Posez votre question...";
                displayMessage("Bonjour ! Comment puis-je vous aider avec vos notes aujourd'hui ?", 'ai');
            } else if (state === 'loading') {
                chatInput.placeholder = "Chargement de l'assistant...";
            } else if (state === 'idle') {
                chatInput.focus();
            }
        }

        function fetchApiKey() {
            fetch(appScriptUrl)
                .then(response => response.json())
                .then(data => {
                    if (data && data.status === "success" && data.data.firstBox) {
                        geminiApiKey = data.data.firstBox.trim();
                        setChatState('ready');
                    } else { throw new Error("Clé API non valide reçue."); }
                })
                .catch(error => {
                    displayMessage(`**Erreur de chargement :** Impossible de contacter le serveur pour initialiser l'assistant. Veuillez réessayer plus tard.`, 'ai');
                    console.error("MBS Chatbot: API Key fetch error:", error);
                });
        }

        function setupEventListeners() {
            toggleButton.addEventListener('click', () => {
                if (!toggleButton.classList.contains('loading')) {
                    container.classList.toggle('expanded');
                    if (container.classList.contains('expanded')) {
                        chatInput.focus();
                    }
                }
            });
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (userMessage && !isFetching) {
                    addUserMessageToHistory(userMessage);
                    chatInput.value = '';
                    processUserMessage();
                }
            });
        }
        
        function addUserMessageToHistory(message) {
            displayMessage(message, 'user');
             conversationHistory.push({ role: 'user', parts: [{ text: message }] });
        }

        function displayMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mbs-chat-message ${sender}`;
            // Use marked.parse to convert Markdown to HTML for AI messages
            messageDiv.innerHTML = sender === 'ai' ? marked.parse(message) : message;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }
        
        function showTypingIndicator() {
            if (messagesContainer.querySelector('.mbs-typing-indicator')) return;
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'mbs-typing-indicator';
            indicatorDiv.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(indicatorDiv);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = messagesContainer.querySelector('.mbs-typing-indicator');
            if (indicator) indicator.remove();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getStudentDataContext() {
            const safeParse = (key) => {
                try {
                    const rawData = localStorage.getItem(key);
                    return rawData ? JSON.parse(rawData) : { error: `Données non trouvées: ${key}` };
                } catch (e) { return { error: `Erreur d'analyse: ${key}` }; }
            };
            return {
                mbsData: safeParse('mbsData'),
                mbsProjectionCache: safeParse('mbsProjectionCache')
            };
        }

        async function processUserMessage() {
            if (!geminiApiKey) return;
            setChatState('fetching');
            showTypingIndicator();

            const dataContext = JSON.stringify(getStudentDataContext(), null, 2);
            
            // Construct the payload with system prompt and conversation history
            const contents = [
                ...conversationHistory.slice(0, -1), // All previous turns
                { // The last user message, augmented with system prompt and data
                   role: 'user',
                   parts: [{ text: `${SYSTEM_PROMPT}\n\n[START_STUDENT_DATA_CONTEXT]\n${dataContext}\n[END_STUDENT_DATA_CONTEXT]\n\n**Question de l'élève :** ${conversationHistory[conversationHistory.length - 1].parts[0].text}` }]
                }
            ];
            
            const payload = { contents };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Erreur HTTP : ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                removeTypingIndicator();
                displayMessage(aiResponse, 'ai');

            } catch (error) {
                removeTypingIndicator();
                displayMessage(`**Erreur Critique :** ${error.message}`, 'ai');
                console.error("MBS Chatbot: Fatal Error:", error);
            } finally {
                setChatState('idle');
            }
        }
        
        init(); // Start the chatbot
    })();
</script>

</body>
</html>
