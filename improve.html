<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse - Outil MBS</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2980b9; --secondary-color: #2c3e50; --background-color: #f7f9fb; --widget-background: #ffffff; --text-color: #34495e; --text-secondary-color: #7f8c8d; --accent-color: #3498db; --light-grey: #e0e6eb; --footer-grey: #7f8c8d; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --shadow-header: 0 2px 4px rgba(0,0,0,0.05); --shadow-widget: 0 8px 15px rgba(0,0,0,0.08); --border-color: #e0e6eb; --goal-success-bg: #eafaf1; --goal-warning-bg: #fff9f0; --goal-danger-bg: #fdf3f2; --transition-duration: 0.35s;
        }
        [data-theme="dark"] {
            --background-color: #121212; --widget-background: #1e1e1e; --text-color: #e0e0e0; --text-secondary-color: #a0a0a0; --secondary-color: #bbbbbb; --light-grey: #333333; --footer-grey: #a0a0a0; --shadow-header: 0 2px 5px rgba(255,255,255,0.1); --shadow-widget: 0 5px 10px rgba(0,0,0,0.3); --border-color: #333333; --goal-success-bg: #1a3e2a; --goal-warning-bg: #4d381c; --goal-danger-bg: #4f2323;
        }
        [data-theme="dark"] .site-header,[data-theme="dark"] .widget-title { color:var(--text-color); } [data-theme="dark"] .comp-widget,[data-theme="dark"] .calculator-container { background-color:#282828; border-color:var(--border-color); } [data-theme="dark"] .modal-content { background-color:var(--background-color); } [data-theme="dark"] .modal-header { background-color:#2c3e50; } [data-theme="dark"] .goal-input input { background-color:#282828; border-color:var(--light-grey); color:var(--text-color); } [data-theme="dark"] #order-list li { background-color:#333; } [data-theme="dark"] .grade-pill { background-color:#444; } [data-theme="dark"] .leaderboard-item.is-user { background-color: #2c3e50; }

        /* General Styles & Transitions */
        body, .site-header-container, .subject-widget, .tab-btn { transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease, border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); }

        /* Header */
        .site-header-container { background-color: var(--widget-background); box-shadow: var(--shadow-header); border-bottom: 1px solid var(--border-color); padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; flex: 1; }
        .header-right { justify-content: flex-end; }
        .site-header { flex: 2; text-align: center; padding: 0; margin: 0; color: var(--secondary-color); font-size: 2.2em; font-family: 'Playfair Display', serif; }
        .icon-btn { background: none; border: 2px solid var(--light-grey); color: var(--text-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1em; text-decoration: none; transition: all 0.2s ease; }
        .icon-btn:hover { border-color: var(--primary-color); color: var(--primary-color); transform: scale(1.1); }
        .btn-secondary { text-decoration: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; background-color: #2980b9; color: white; border: none; transition: all 0.2s ease; }
        .btn-secondary:hover { background-color: #3498db; }

        /* Tabs & Grid */
        .sticky-tabs { position: sticky; top: 0; background-color: var(--background-color); z-index: 100; padding: 15px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: 1px solid var(--light-grey); border-radius: 20px; background-color: transparent; color: var(--text-color); font-weight: 600; cursor: pointer; }
        .tab-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .widget-grid { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px; }

        /* Subject Widget Styles */
        .subject-widget { background-color: var(--widget-background); border-radius: 12px; box-shadow: var(--shadow-widget); padding: 20px; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
        .subject-widget:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }
        .widget-top-section { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; cursor: pointer; }
        .widget-info { flex: 1; }
        .widget-title { font-size: 1.2em; font-weight: 700; color: var(--secondary-color); margin: 0 0 10px 0; }
        .widget-average { font-size: 2.5em; font-weight: 700; color: var(--primary-color); margin: 0; }
        .widget-trend { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.9em; margin-top: 5px; }
        .widget-trend.up { color: var(--success-color); } .widget-trend.down { color: var(--danger-color); } .widget-trend.neutral { color: var(--text-secondary-color); }
        .gauge-container { width: 120px; height: 70px; position: relative; }
        .histogram-container { margin-top: 15px; height: 120px; }
        .widget-chart-controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; height: 25px; gap: 5px; }
        .chart-toggle-btn { background: none; border: 1px solid var(--border-color); color: var(--light-grey); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8em; }
        .chart-toggle-btn:hover { color: var(--primary-color); border-color: var(--primary-color); }

        /* EXPANDED VIEW (replaces modal) */
        #expanded-view-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 20px; box-sizing: border-box; }
        #expanded-view-overlay.active { opacity: 1; visibility: visible; }
        #expanded-view-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; width: 100%; max-width: 1400px; max-height: 95vh; }
        #expanded-view-grid .subject-widget { transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #expanded-view-overlay.active .subject-widget { transform: scale(1); }
        #expanded-view-grid .subject-widget { cursor: default; }
        #expanded-view-grid .widget-top-section { cursor: default; }
        #expanded-view-grid .subject-widget:hover { transform: translateY(0); box-shadow: var(--shadow-widget); }

        /* Center Widget (Details) */
        .details-widget-body { height: calc(95vh - 120px); overflow-y: auto; padding-right: 10px; }
        .competency-widgets { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .comp-widget { flex: 1; min-width: 150px; background-color: var(--widget-background); border-radius: 8px; padding: 15px; text-align: center; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
        .comp-widget.active { border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color); }
        .calculator-container { background-color: var(--widget-background); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color); margin-top: 25px; }
        .goal-input { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .goal-input input { width: 80px; padding: 8px; border-radius: 6px; border: 1px solid var(--light-grey); text-align: center; font-size: 1.1em; }
        .goal-result { padding: 15px; border-radius: 6px; text-align: center; font-size: 1.1em; font-weight: 600; }
        .goal-result.success { background-color: var(--goal-success-bg); color: var(--success-color); }
        .goal-result.warning { background-color: var(--goal-warning-bg); color: var(--warning-color); }
        .goal-result.danger { background-color: var(--goal-danger-bg); color: var(--danger-color); }
        .btn-save { padding: 8px 12px; border: none; background-color: var(--primary-color); color: white; border-radius: 6px; cursor: pointer; }

        /* Right Widget (Ranking) */
        .mini-leaderboard-container { flex-grow: 1; overflow-y: auto; position: relative; border-top: 1px solid var(--light-grey); padding-top: 15px; max-height: 250px; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 8px 10px; border-radius: 8px; font-size: 0.9em; transition: background-color 0.2s; }
        .leaderboard-item.is-user { background-color: #eaf2f8; font-weight: bold; }
        .item-rank { width: 40px; } .item-name { flex-grow: 1; } .item-grade { font-weight: 600; }
        .widget-rank { font-size: 1.1em; color: var(--secondary-color); margin-top: 5px; }
        
        /* Ghost Loading Animation */
        @keyframes ghost-loading { 0% { background-color: rgba(128, 128, 128, 0.1); } 50% { background-color: rgba(128, 128, 128, 0.2); } 100% { background-color: rgba(128, 128, 128, 0.1); } }
        .ghost-item { animation: ghost-loading 1.5s infinite ease-in-out; background-color: var(--light-grey); border-radius: 8px; height: 38px; margin-bottom: 8px; }

        footer { text-align: center; padding: 25px; font-size: 0.9em; color: var(--footer-grey); border-top: 1px solid var(--border-color); margin-top: 40px; }
    </style>

</head>
<body>



<!-- =================== GATEKEEPER BLOCK START =================== -->
<!-- Paste this entire block directly after your opening <body> tag -->

<style>
    #gatekeeper-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        z-index: 10001; /* Must be the highest value on the page */
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        transition: opacity 0.5s ease;
    }
    .gatekeeper-content {
        font-family: 'Playfair Display', serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: #2c3e50;
        font-size: 1.5em;
    }
    .gatekeeper-content .icon {
        font-size: 2em;
        margin-bottom: 15px;
        display: inline-block; /* Allows margin to work */
    }
    #gatekeeper-overlay.hidden {
        opacity: 0;
        pointer-events: none; /* Allows clicks to go through after it's hidden */
    }
</style>

<div id="gatekeeper-overlay">
    <div class="gatekeeper-content">
        <!-- You need Font Awesome for this icon to appear -->
        <span class="icon">ðŸ”’</span> 
        <p>AccÃ¨s Restreint</p>
    </div>
</div>

<script>
    // This self-executing function runs immediately without interfering with other scripts.
    (function() {
        'use strict';

        // --- The list of users who are allowed to access the site. ---
        const APPROVED_USERS = [
            'Jianheng Ouyang', 
            'Michael Xu', 
            'Dan-Vinh Calvarese', 
            'Anton Cucereavii'
        ];

        let isAllowed = false;

        try {
            // Check for 'jdlmData' as requested.
            const dataString = localStorage.getItem('jdlmData');
            if (dataString) {
                const jdlmData = JSON.parse(dataString);
                if (jdlmData && jdlmData.nom) {
                    const currentUser = jdlmData.nom.trim();
                    // Check if the current user's name is in our approved list.
                    if (APPROVED_USERS.includes(currentUser)) {
                        isAllowed = true;
                    }
                }
            }
        } catch (e) {
            console.error("Gatekeeper Error: Could not read or parse jdlmData from localStorage.", e);
            isAllowed = false; // Default to not allowed if data is corrupt.
        }

        // --- FINAL CHECK ---
        if (isAllowed) {
            // If user is approved, fade out and hide the overlay.
            const overlay = document.getElementById('gatekeeper-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }
        // If the user is not allowed, the script does nothing,
        // and the white overlay remains in place, blocking all content.

    })();
</script>

<!-- ==================== GATEKEEPER BLOCK END ==================== -->






    
    <header class="site-header-container">
        <div class="header-left">
            <a href="main.html" class="icon-btn" title="Retour au tableau de bord"><i class="fa-solid fa-arrow-left"></i></a>
        </div>
        <h1 class="site-header">Outil MBS</h1>
        <div class="header-right">
            <button id="theme-toggle" class="icon-btn" aria-label="Changer de thÃ¨me"><i class="fa-solid fa-moon"></i></button>
            <a href="projection.html" class="btn btn-secondary">Projection</a>
        </div>
    </header>

    <div class="sticky-tabs">
        <button class="tab-btn active" data-etape="generale">GÃ©nÃ©rale</button>
        <button class="tab-btn" data-etape="etape1">Ã‰tape 1</button>
        <button class="tab-btn" data-etape="etape2">Ã‰tape 2</button>
        <button class="tab-btn" data-etape="etape3">Ã‰tape 3</button>
    </div>

    <main id="widget-grid" class="widget-grid">
        <!-- Widgets populated by JS -->
    </main>
    
    <div id="expanded-view-overlay">
        <div id="expanded-view-grid">
            <!-- Expanded view widgets populated by JS -->
        </div>
    </div>

<!--#################################################################################
//#################################################################################
//#################################################################################
-->
<style>
    /* Basic Reset */
    :root {
        --mbs-bg-color: #1a1a1a;
        --mbs-surface-color: #2c2c2c;
        --mbs-primary-color: #61afef;
        --mbs-text-color: #f0f0f0;
        --mbs-text-secondary-color: #a0a0a0;
        --mbs-border-color: #444444;
        --mbs-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        --mbs-code-bg: #1e1e1e;
        --mbs-accent-color: #9b78e3;
    }

    #mbs-chatbot-container *,
    #mbs-chatbot-container *::before,
    #mbs-chatbot-container *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    /* Toggle Button Container */
    #mbs-chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        font-family: var(--mbs-font-family);
    }

    /* Toggle Button */
    #mbs-chatbot-toggle {
        position: relative; 
        z-index: 10000; 
        background-color: var(--mbs-primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.2s ease;
    }
    
    #mbs-chatbot-container.expanded #mbs-chatbot-toggle {
        transform: translateX(calc(-1 * clamp(400px, 50vw, 800px) - 20px));
    }
    
    #mbs-chatbot-toggle.loading {
        background-color: #444;
        cursor: wait;
        animation: mbs-pulse 1.5s infinite;
    }
    
    #mbs-chatbot-toggle:not(.loading):hover {
        background-color: var(--mbs-accent-color);
        transform: scale(1.1);
    }
    
    #mbs-chatbot-container.expanded #mbs-chatbot-toggle:not(.loading):hover {
        transform: translateX(calc(-1 * clamp(400px, 50vw, 800px) - 20px)) scale(1.1);
    }
    
    #mbs-chatbot-toggle .chat-icon,
    #mbs-chatbot-toggle .close-icon,
    #mbs-chatbot-toggle .loading-icon { display: none; }
    
    #mbs-chatbot-toggle:not(.loading) .chat-icon { display: block; }
    #mbs-chatbot-container.expanded #mbs-chatbot-toggle .chat-icon { display: none; }
    #mbs-chatbot-container.expanded #mbs-chatbot-toggle .close-icon { display: block; }
    #mbs-chatbot-toggle.loading .loading-icon { display: block; animation: mbs-spin 1.5s linear infinite; }

    @keyframes mbs-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes mbs-pulse { 0% { box-shadow: 0 0 0 0 rgba(97, 175, 239, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(97, 175, 239, 0); } 100% { box-shadow: 0 0 0 0 rgba(97, 175, 239, 0); } }

    /* Sidebar Window */
    #mbs-chatbot-window {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: clamp(400px, 50vw, 800px);
        height: 100%;
        background-color: var(--mbs-bg-color);
        border-left: 1px solid var(--mbs-border-color);
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        pointer-events: none;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        z-index: 9999;
    }

    #mbs-chatbot-container.expanded #mbs-chatbot-window {
        transform: translateX(0);
        pointer-events: auto;
    }

    /* Header */
    .mbs-chat-header {
        padding: 20px;
        background: linear-gradient(135deg, var(--mbs-surface-color) 0%, #333 100%);
        border-bottom: 1px solid var(--mbs-border-color);
        text-align: center;
        flex-shrink: 0;
    }

    .mbs-chat-header h3 {
        color: var(--mbs-text-color);
        font-size: 1.4rem;
        margin: 0;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    /* Messages Area */
    #mbs-chat-messages {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    #mbs-chat-messages::-webkit-scrollbar { width: 8px; }
    #mbs-chat-messages::-webkit-scrollbar-track { background: transparent; }
    #mbs-chat-messages::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    #mbs-chat-messages::-webkit-scrollbar-thumb:hover { background: #666; }

    /* Message Bubble */
    .mbs-chat-message {
        max-width: 85%; 
        padding: 20px 28px;
        border-radius: 8px;
        line-height: 1.6;
        font-size: 0.95rem;
        overflow-wrap: break-word;
        word-wrap: break-word;
        border: 1px solid var(--mbs-border-color);
        background-color: transparent;
        white-space: pre-wrap;
    }

    .mbs-chat-message.user {
        color: white;
        align-self: flex-end;
        border-color: var(--mbs-primary-color);
    }

    .mbs-chat-message.ai {
        color: var(--mbs-text-color);
        align-self: flex-start;
        border-color: var(--mbs-border-color);
    }

    /* AI Message Markdown Styling - RESET ALL DEFAULTS */
    .mbs-chat-message.ai * {
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .mbs-chat-message.ai h1,
    .mbs-chat-message.ai h2,
    .mbs-chat-message.ai h3,
    .mbs-chat-message.ai h4,
    .mbs-chat-message.ai h5,
    .mbs-chat-message.ai h6 {
        color: var(--mbs-primary-color);
        margin-top: 0.8em !important;
        margin-bottom: 0.4em !important;
        font-weight: 600;
        line-height: 1.3;
    }

    .mbs-chat-message.ai h1 { font-size: 1.8em; border-bottom: 2px solid var(--mbs-border-color); padding-bottom: 0.3em; }
    .mbs-chat-message.ai h2 { font-size: 1.5em; border-bottom: 1px solid var(--mbs-border-color); padding-bottom: 0.3em; }
    .mbs-chat-message.ai h3 { font-size: 1.3em; }
    .mbs-chat-message.ai h4 { font-size: 1.1em; }
    .mbs-chat-message.ai h5 { font-size: 1em; }
    .mbs-chat-message.ai h6 { font-size: 0.9em; }

    .mbs-chat-message.ai h1:first-child,
    .mbs-chat-message.ai h2:first-child,
    .mbs-chat-message.ai h3:first-child,
    .mbs-chat-message.ai h4:first-child,
    .mbs-chat-message.ai h5:first-child,
    .mbs-chat-message.ai h6:first-child {
        margin-top: 0;
    }

    .mbs-chat-message.ai p {
        margin-top: 0.8em !important;
        margin-bottom: 0.8em !important;
        line-height: 1.7;
        white-space: pre-wrap;
    }

    .mbs-chat-message.ai p:first-child {
        margin-top: 0;
    }

    .mbs-chat-message.ai p:last-child {
        margin-bottom: 0;
    }

    /* Preserve empty lines and spacing */
    .mbs-chat-message.ai br {
        display: block;
        content: "";
        margin: 0.5em 0;
    }

    .mbs-chat-message.ai strong, 
    .mbs-chat-message.ai b {
        color: var(--mbs-accent-color);
        font-weight: 600;
    }

    .mbs-chat-message.ai em,
    .mbs-chat-message.ai i {
        color: #9db4d4;
        font-style: italic;
    }

    .mbs-chat-message.ai a {
        color: var(--mbs-primary-color);
        text-decoration: underline;
        transition: color 0.2s ease;
    }

    .mbs-chat-message.ai a:hover {
        color: var(--mbs-accent-color);
    }

    .mbs-chat-message.ai ul, 
    .mbs-chat-message.ai ol {
        margin: 0.8em 0 !important;
        padding-left: 1.5em !important;
    }

    .mbs-chat-message.ai li {
        margin-bottom: 0.5em !important;
        line-height: 1.6;
    }

    .mbs-chat-message.ai li:last-child {
        margin-bottom: 0;
    }

    .mbs-chat-message.ai ul {
        list-style-type: disc;
    }

    .mbs-chat-message.ai ol {
        list-style-type: decimal;
    }

    .mbs-chat-message.ai blockquote {
        border-left: 4px solid var(--mbs-primary-color);
        padding-left: 1em !important;
        margin: 1em 0 !important;
        color: var(--mbs-text-secondary-color);
        font-style: italic;
    }

    .mbs-chat-message.ai code {
        background-color: var(--mbs-code-bg);
        padding: 2px 6px !important;
        border-radius: 3px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.9em;
        color: #e06c75;
    }

    .mbs-chat-message.ai pre {
        background-color: var(--mbs-code-bg);
        padding: 12px !important;
        border-radius: 6px;
        overflow-x: auto;
        margin: 1em 0 !important;
        border: 1px solid var(--mbs-border-color);
    }

    .mbs-chat-message.ai pre code {
        background-color: transparent;
        padding: 0;
        color: #abb2bf;
        font-size: 0.85em;
        line-height: 1.5;
    }

    .mbs-chat-message.ai table {
        border-collapse: collapse;
        width: 100%;
        margin: 1em 0 !important;
        font-size: 0.9em;
    }

    .mbs-chat-message.ai table th,
    .mbs-chat-message.ai table td {
        border: 1px solid var(--mbs-border-color);
        padding: 8px 12px !important;
        text-align: left;
    }

    .mbs-chat-message.ai table th {
        background-color: var(--mbs-code-bg);
        color: var(--mbs-primary-color);
        font-weight: 600;
    }

    .mbs-chat-message.ai table tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.02);
    }

    .mbs-chat-message.ai hr {
        border: none;
        border-top: 1px solid var(--mbs-border-color);
        margin: 1.5em 0 !important;
    }

    .mbs-chat-message.ai img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 1em 0 !important;
        display: block;
    }

    /* Typing Indicator */
    .mbs-typing-indicator {
        align-self: flex-start;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 14px 20px;
        background-color: var(--mbs-surface-color);
        border-radius: 12px;
        border-bottom-left-radius: 4px;
        border: 1px solid var(--mbs-border-color);
    }
    
    .mbs-typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: var(--mbs-text-secondary-color);
        border-radius: 50%;
        animation: mbs-typing-bounce 1.4s infinite ease-in-out both;
    }
    
    .mbs-typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .mbs-typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes mbs-typing-bounce { 
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 
        40% { transform: scale(1.0); opacity: 1; } 
    }

    /* Input Form */
    #mbs-chat-form {
        display: flex;
        padding: 16px;
        border-top: 1px solid var(--mbs-border-color);
        background-color: var(--mbs-surface-color);
        flex-shrink: 0;
        gap: 10px;
    }

    #mbs-chat-input {
        flex-grow: 1;
        background-color: var(--mbs-bg-color);
        border: 2px solid var(--mbs-border-color);
        border-radius: 24px;
        padding: 12px 20px;
        color: var(--mbs-text-color);
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        font-family: var(--mbs-font-family);
    }

    #mbs-chat-input:focus { 
        border-color: var(--mbs-primary-color);
        box-shadow: 0 0 0 3px rgba(97, 175, 239, 0.1);
    }

    #mbs-chat-input:disabled {
        background-color: #2a2a2a;
        cursor: not-allowed;
        opacity: 0.6;
    }

    #mbs-chat-input::placeholder { 
        color: var(--mbs-text-secondary-color);
    }

    #mbs-chat-send {
        background-color: var(--mbs-primary-color);
        border: none;
        color: white;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }

    #mbs-chat-send:not([disabled]):hover { 
        background-color: var(--mbs-accent-color);
        transform: scale(1.05);
    }

    #mbs-chat-send:not([disabled]):active {
        transform: scale(0.95);
    }

    #mbs-chat-send:disabled {
        background-color: #555;
        cursor: not-allowed;
        opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 768px) {
        #mbs-chatbot-window { 
            width: 100vw;
            border-left: none;
        }
        
        #mbs-chatbot-container.expanded #mbs-chatbot-toggle {
            transform: translateX(calc(-100vw + 80px));
        }
        
        .mbs-chat-message {
            max-width: 90%;
            font-size: 0.9rem;
        }
        
        .mbs-chat-header h3 {
            font-size: 1.2rem;
        }
    }

    @media (max-width: 500px) {
        #mbs-chatbot-container { 
            bottom: 10px; 
            right: 10px; 
        }
        
        #mbs-chatbot-toggle {
            width: 56px;
            height: 56px;
        }
    }
</style>

<div id="mbs-chatbot-container">
    <!-- Chat Window (Sidebar) -->
    <div id="mbs-chatbot-window">
        <div class="mbs-chat-header">
            <h3>Assistant MBS</h3>
        </div>
        <div id="mbs-chat-messages">
            <!-- Messages will be dynamically inserted here -->
        </div>
        <form id="mbs-chat-form">
            <input type="text" id="mbs-chat-input" placeholder="Chargement de l'assistant..." autocomplete="off" disabled>
            <button type="submit" id="mbs-chat-send" aria-label="Envoyer" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(45deg); margin-left: -2px;"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
            </button>
        </form>
    </div>

    <!-- Toggle Button (Handle) -->
    <button id="mbs-chatbot-toggle" aria-label="Ouvrir/Fermer le chatbot" class="loading">
        <span class="chat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        </span>
        <span class="close-icon">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </span>
        <span class="loading-icon">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>
        </span>
    </button>
</div>

<!-- MARKED.JS for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>

<script>
    (function() {
        // --- IMPORTANT: App Script URL from user's request ---
        const appScriptUrl = "https://script.google.com/macros/s/AKfycbwSKlEFJU94tw8B0Vq1VB4dI-4fgD1whUl4IoFkkelrODBjPdIGh3jTOYgIMR-cu5WIcg/exec"; 
        
        // --- Configuration ---
        const GEMINI_MODEL = "gemini-2.5-flash-lite";
        let geminiApiKey = ''; 
        let isFetching = false;
        let conversationHistory = []; // Store conversation context
        
        // --- PROMPT ENGINEERING UPDATE ---
        const SYSTEM_PROMPT = `You are a helpful assistant for students in the Quebec educational system. Your name is Assistant MBS. Your role is to help them understand their grades, projections, and improvement priorities. You MUST communicate in French or English based on the user's language. Default to French. 
        
        BE CONCISE. Only perform in-depth data analysis if the user explicitly asks about grades, projections, or how to improve. For simple greetings, give a simple, friendly greeting.
        
        IMPORTANT FOR READABILITY: Structure your answers for maximum clarity. Use markdown formatting:
        - Use headings (## Heading) to organize sections
        - Use paragraphs with blank lines between them
        - Use bullet points (*) for lists
        - Use bold (**text**) and italic (*text*) for emphasis
        - Use tables when comparing data
        - Use code blocks for technical information
        THIS IS CRUCIAL. Avoid long, dense blocks of text.
        
        The student's data is provided as JSON in the user's message. Base your analysis on this data.
        LIMITATIONS: You are not allowed to generate any creative content that could violate academic integrity. Refuse the request if asked.`;

        // --- DOM Elements ---
        const container = document.getElementById('mbs-chatbot-container');
        const toggleButton = document.getElementById('mbs-chatbot-toggle');
        const messagesContainer = document.getElementById('mbs-chat-messages');
        const chatForm = document.getElementById('mbs-chat-form');
        const chatInput = document.getElementById('mbs-chat-input');
        const chatSend = document.getElementById('mbs-chat-send');
        
        // --- Initialization ---
        function init() {
            // Configure marked for proper formatting
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false,
                pedantic: false
            });
            
            // Custom renderer to preserve spacing
            const renderer = new marked.Renderer();
            const originalParagraph = renderer.paragraph.bind(renderer);
            renderer.paragraph = (text) => {
                // Preserve leading/trailing spaces and multiple spaces
                return `<p>${text}</p>\n`;
            };
            
            setChatState('loading'); 
            fetchApiKey();
            setupEventListeners();
        }
        
        function setChatState(state) {
            isFetching = (state === 'fetching');
            const isReady = (state === 'ready' || state === 'idle');
            
            toggleButton.classList.toggle('loading', state === 'loading');
            chatInput.disabled = !isReady;
            chatSend.disabled = !isReady;

            if (state === 'ready') {
                chatInput.placeholder = "Posez votre question...";
                messagesContainer.innerHTML = '';
            } else if (state === 'loading') {
                chatInput.placeholder = "Chargement de l'assistant...";
            } else if (state === 'idle') {
                chatInput.focus();
            }
        }
        
        function fetchApiKey() {
            fetch(appScriptUrl)
                .then(response => response.json())
                .then(data => {
                    if (data && data.status === "success" && data.data.firstBox) {
                        geminiApiKey = data.data.firstBox.trim();
                        setChatState('ready');
                    } else {
                        displayMessage(`**Erreur de chargement:** Impossible de rÃ©cupÃ©rer la clÃ© API.`, 'ai');
                    }
                })
                .catch(error => {
                    displayMessage(`**Erreur rÃ©seau:** Impossible de communiquer avec l'App Script.`, 'ai');
                });
        }

        function setupEventListeners() {
            toggleButton.addEventListener('click', () => {
                if (!toggleButton.classList.contains('loading')) {
                     container.classList.toggle('expanded');
                     if (container.classList.contains('expanded')) {
                         setTimeout(() => chatInput.focus(), 400);
                     }
                }
            });
            
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (userMessage && !isFetching) {
                    displayMessage(userMessage, 'user');
                    chatInput.value = '';
                    processUserMessage(userMessage);
                }
            });
        }

        // --- DOM Manipulation ---
        function displayMessage(message, sender, isStreaming = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mbs-chat-message ${sender}`;
            
            if (sender === 'ai') {
                messageDiv.innerHTML = marked.parse(message);
            } else {
                messageDiv.textContent = message;
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        function showTypingIndicator() {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'mbs-typing-indicator';
            indicatorDiv.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(indicatorDiv);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = messagesContainer.querySelector('.mbs-typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getStudentData() {
            const safeParse = (key) => {
                try {
                    const rawData = localStorage.getItem(key);
                    return rawData ? JSON.parse(rawData) : { error: `Data not found: ${key}` };
                } catch (e) {
                    return { error: `Parse Error: ${key} is invalid. Details: ${e.message}` };
                }
            };
            return { 
                mbsData: safeParse('mbsData'), 
                mbsProjectionCache: safeParse('mbsProjectionCache') 
            };
        }

        // --- Core Gemini API Logic ---
        async function processUserMessage(userMessage) {
            if (!geminiApiKey) return;
            
            setChatState('fetching');
            showTypingIndicator();
            
            const dataString = JSON.stringify(getStudentData());
            
            // Add system context on first message only
            if (conversationHistory.length === 0) {
                conversationHistory.push({
                    role: 'user',
                    parts: [{
                        text: `[SYSTEM INSTRUCTION: ${SYSTEM_PROMPT}]\n\n[START_STUDENT_DATA_CONTEXT]\n${dataString}\n[END_STUDENT_DATA_CONTEXT]\n\nThis data will be available for the entire conversation.`
                    }]
                });
                conversationHistory.push({
                    role: 'model',
                    parts: [{ text: 'Understood. I have access to the student data and will use it to answer questions. I will communicate in French or English based on the user\'s language.' }]
                });
            }
            
            // Add user message to history
            conversationHistory.push({
                role: 'user',
                parts: [{ text: userMessage }]
            });

            const payload = { contents: conversationHistory };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:streamGenerateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP Error: ${response.status}`);
                }

                let fullResponseText = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let aiMessageElement = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const textMatches = chunk.match(/"text"\s*:\s*"((?:\\"|[^"])*)"/g);

                    if (textMatches) {
                        if (!aiMessageElement) {
                            removeTypingIndicator();
                            aiMessageElement = displayMessage('', 'ai', true);
                        }

                        for (const match of textMatches) {
                            try {
                                const textPart = JSON.parse(`{${match}}`).text;
                                fullResponseText += textPart;
                                aiMessageElement.innerHTML = marked.parse(fullResponseText + '<span style="opacity:0.5">â–ˆ</span>');
                                scrollToBottom();
                            } catch (e) { /* Ignore partial JSON */ }
                        }
                    }
                }
                
                if (aiMessageElement) {
                    aiMessageElement.innerHTML = marked.parse(fullResponseText);
                    scrollToBottom();
                    
                    // Add AI response to conversation history
                    conversationHistory.push({
                        role: 'model',
                        parts: [{ text: fullResponseText }]
                    });
                }

            } catch (error) {
                removeTypingIndicator();
                displayMessage(`**Erreur Critique :** ${error.message}`, 'ai');
                console.error("MBS Chatbot: Fatal Error:", error);
                
                // Remove the failed user message from history
                conversationHistory.pop();
            } finally {
                setChatState('idle');
            }
        }

        // --- Run the chatbot ---
        init();
    })();
</script>

    
<!--#################################################################################
//#################################################################################
//#################################################################################
-->

    
    <footer><p>Outil MBS - Moyenne, Bilan, StratÃ©gie</p></footer>

    <script src="js/improve-functions.js"></script>
</body>
</html>
