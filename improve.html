<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse - Outil MBS</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2980b9; --secondary-color: #2c3e50; --background-color: #f7f9fb; --widget-background: #ffffff; --text-color: #34495e; --text-secondary-color: #7f8c8d; --accent-color: #3498db; --light-grey: #e0e6eb; --footer-grey: #7f8c8d; --success-color: #27ae60; --danger-color: #e74c3c; --warning-color: #f39c12; --shadow-header: 0 2px 4px rgba(0,0,0,0.05); --shadow-widget: 0 8px 15px rgba(0,0,0,0.08); --border-color: #e0e6eb; --goal-success-bg: #eafaf1; --goal-warning-bg: #fff9f0; --goal-danger-bg: #fdf3f2; --transition-duration: 0.35s;
        }
        [data-theme="dark"] {
            --background-color: #121212; --widget-background: #1e1e1e; --text-color: #e0e0e0; --text-secondary-color: #a0a0a0; --secondary-color: #bbbbbb; --light-grey: #333333; --footer-grey: #a0a0a0; --shadow-header: 0 2px 5px rgba(255,255,255,0.1); --shadow-widget: 0 5px 10px rgba(0,0,0,0.3); --border-color: #333333; --goal-success-bg: #1a3e2a; --goal-warning-bg: #4d381c; --goal-danger-bg: #4f2323;
        }
        [data-theme="dark"] .site-header,[data-theme="dark"] .widget-title { color:var(--text-color); } [data-theme="dark"] .comp-widget,[data-theme="dark"] .calculator-container { background-color:#282828; border-color:var(--border-color); } [data-theme="dark"] .modal-content { background-color:var(--background-color); } [data-theme="dark"] .modal-header { background-color:#2c3e50; } [data-theme="dark"] .goal-input input { background-color:#282828; border-color:var(--light-grey); color:var(--text-color); } [data-theme="dark"] #order-list li { background-color:#333; } [data-theme="dark"] .grade-pill { background-color:#444; } [data-theme="dark"] .leaderboard-item.is-user { background-color: #2c3e50; }

        /* General Styles & Transitions */
        body, .site-header-container, .subject-widget, .tab-btn { transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease, border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); }

        /* Header */
        .site-header-container { background-color: var(--widget-background); box-shadow: var(--shadow-header); border-bottom: 1px solid var(--border-color); padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; flex: 1; }
        .header-right { justify-content: flex-end; }
        .site-header { flex: 2; text-align: center; padding: 0; margin: 0; color: var(--secondary-color); font-size: 2.2em; font-family: 'Playfair Display', serif; }
        .icon-btn { background: none; border: 2px solid var(--light-grey); color: var(--text-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1em; text-decoration: none; transition: all 0.2s ease; }
        .icon-btn:hover { border-color: var(--primary-color); color: var(--primary-color); transform: scale(1.1); }
        .btn-secondary { text-decoration: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; background-color: #2980b9; color: white; border: none; transition: all 0.2s ease; }
        .btn-secondary:hover { background-color: #3498db; }

        /* Tabs & Grid */
        .sticky-tabs { position: sticky; top: 0; background-color: var(--background-color); z-index: 100; padding: 15px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: 1px solid var(--light-grey); border-radius: 20px; background-color: transparent; color: var(--text-color); font-weight: 600; cursor: pointer; }
        .tab-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .widget-grid { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px; }

        /* Subject Widget Styles */
        .subject-widget { background-color: var(--widget-background); border-radius: 12px; box-shadow: var(--shadow-widget); padding: 20px; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; }
        .subject-widget:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }
        .widget-top-section { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; cursor: pointer; }
        .widget-info { flex: 1; }
        .widget-title { font-size: 1.2em; font-weight: 700; color: var(--secondary-color); margin: 0 0 10px 0; }
        .widget-average { font-size: 2.5em; font-weight: 700; color: var(--primary-color); margin: 0; }
        .widget-trend { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.9em; margin-top: 5px; }
        .widget-trend.up { color: var(--success-color); } .widget-trend.down { color: var(--danger-color); } .widget-trend.neutral { color: var(--text-secondary-color); }
        .gauge-container { width: 120px; height: 70px; position: relative; }
        .histogram-container { margin-top: 15px; height: 120px; }
        .widget-chart-controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; height: 25px; gap: 5px; }
        .chart-toggle-btn { background: none; border: 1px solid var(--border-color); color: var(--light-grey); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8em; }
        .chart-toggle-btn:hover { color: var(--primary-color); border-color: var(--primary-color); }

        /* EXPANDED VIEW (replaces modal) */
        #expanded-view-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 20px; box-sizing: border-box; }
        #expanded-view-overlay.active { opacity: 1; visibility: visible; }
        #expanded-view-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; width: 100%; max-width: 1400px; max-height: 95vh; }
        #expanded-view-grid .subject-widget { transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #expanded-view-overlay.active .subject-widget { transform: scale(1); }
        #expanded-view-grid .subject-widget { cursor: default; }
        #expanded-view-grid .widget-top-section { cursor: default; }
        #expanded-view-grid .subject-widget:hover { transform: translateY(0); box-shadow: var(--shadow-widget); }

        /* Center Widget (Details) */
        .details-widget-body { height: calc(95vh - 120px); overflow-y: auto; padding-right: 10px; }
        .competency-widgets { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .comp-widget { flex: 1; min-width: 150px; background-color: var(--widget-background); border-radius: 8px; padding: 15px; text-align: center; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
        .comp-widget.active { border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color); }
        .calculator-container { background-color: var(--widget-background); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color); margin-top: 25px; }
        .goal-input { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .goal-input input { width: 80px; padding: 8px; border-radius: 6px; border: 1px solid var(--light-grey); text-align: center; font-size: 1.1em; }
        .goal-result { padding: 15px; border-radius: 6px; text-align: center; font-size: 1.1em; font-weight: 600; }
        .goal-result.success { background-color: var(--goal-success-bg); color: var(--success-color); }
        .goal-result.warning { background-color: var(--goal-warning-bg); color: var(--warning-color); }
        .goal-result.danger { background-color: var(--goal-danger-bg); color: var(--danger-color); }
        .btn-save { padding: 8px 12px; border: none; background-color: var(--primary-color); color: white; border-radius: 6px; cursor: pointer; }

        /* Right Widget (Ranking) */
        .mini-leaderboard-container { flex-grow: 1; overflow-y: auto; position: relative; border-top: 1px solid var(--light-grey); padding-top: 15px; max-height: 250px; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 8px 10px; border-radius: 8px; font-size: 0.9em; transition: background-color 0.2s; }
        .leaderboard-item.is-user { background-color: #eaf2f8; font-weight: bold; }
        .item-rank { width: 40px; } .item-name { flex-grow: 1; } .item-grade { font-weight: 600; }
        .widget-rank { font-size: 1.1em; color: var(--secondary-color); margin-top: 5px; }
        
        /* Ghost Loading Animation */
        @keyframes ghost-loading { 0% { background-color: rgba(128, 128, 128, 0.1); } 50% { background-color: rgba(128, 128, 128, 0.2); } 100% { background-color: rgba(128, 128, 128, 0.1); } }
        .ghost-item { animation: ghost-loading 1.5s infinite ease-in-out; background-color: var(--light-grey); border-radius: 8px; height: 38px; margin-bottom: 8px; }

        /* --- Chatbot Specific CSS Adjustments for links/markdown --- */
        #mbs-chat-messages a {
            color: #61afef;
            text-decoration: underline; /* Added underline for clear link demarcation */
        }
        .mbs-chat-message.ai strong, .mbs-chat-message.ai b {
            color: #e5c0ff;
            font-weight: 700;
        }

        footer { text-align: center; padding: 25px; font-size: 0.9em; color: var(--footer-grey); border-top: 1px solid var(--border-color); margin-top: 40px; }
    </style>
</head>
<body>
    <header class="site-header-container">
        <div class="header-left">
            <a href="main.html" class="icon-btn" title="Retour au tableau de bord"><i class="fa-solid fa-arrow-left"></i></a>
        </div>
        <h1 class="site-header">Outil MBS</h1>
        <div class="header-right">
            <button id="theme-toggle" class="icon-btn" aria-label="Changer de thème"><i class="fa-solid fa-moon"></i></button>
            <a href="projection.html" class="btn btn-secondary">Projection</a>
        </div>
    </header>

    <div class="sticky-tabs">
        <button class="tab-btn active" data-etape="generale">Générale</button>
        <button class="tab-btn" data-etape="etape1">Étape 1</button>
        <button class="tab-btn" data-etape="etape2">Étape 2</button>
        <button class="tab-btn" data-etape="etape3">Étape 3</button>
    </div>

    <main id="widget-grid" class="widget-grid">
        <!-- Widgets populated by JS -->
    </main>
    
    <div id="expanded-view-overlay">
        <div id="expanded-view-grid">
            <!-- Expanded view widgets populated by JS -->
        </div>
    </div>



<style>
    /* Basic Reset */
    :root {
        --mbs-bg-color: #1a1a1a;
        --mbs-surface-color: #2c2c2c;
        --mbs-primary-color: #61afef;
        --mbs-text-color: #f0f0f0;
        --mbs-text-secondary-color: #a0a0a0;
        --mbs-border-color: #444444;
        --mbs-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    #mbs-chatbot-container *,
    #mbs-chatbot-container *::before,
    #mbs-chatbot-container *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    /* Toggle Button Container */
    #mbs-chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        font-family: var(--mbs-font-family);
    }

/* Toggle Button */
#mbs-chatbot-toggle {
    position: relative; 
    z-index: 10000; 
    background-color: var(--mbs-primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.2s ease;
}
#mbs-chatbot-container.expanded #mbs-chatbot-toggle {
    transform: translateX(calc(-1 * clamp(400px, 50vw, 800px)));
}
    #mbs-chatbot-toggle.loading {
        background-color: #444;
        cursor: wait;
        animation: mbs-pulse 1.5s infinite;
    }
    #mbs-chatbot-toggle:not(.loading):hover {
        background-color: #9b78e3;
        transform: scale(1.1);
    }
    
    #mbs-chatbot-toggle .chat-icon,
    #mbs-chatbot-toggle .close-icon,
    #mbs-chatbot-toggle .loading-icon { display: none; }
    
    #mbs-chatbot-toggle:not(.loading) .chat-icon { display: block; }
    #mbs-chatbot-container.expanded #mbs-chatbot-toggle .chat-icon { display: none; }
    #mbs-chatbot-container.expanded #mbs-chatbot-toggle .close-icon { display: block; }
    #mbs-chatbot-toggle.loading .loading-icon { display: block; animation: mbs-spin 1.5s linear infinite; }

    @keyframes mbs-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes mbs-pulse { 0% { box-shadow: 0 0 0 0 rgba(138, 99, 210, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(138, 99, 210, 0); } 100% { box-shadow: 0 0 0 0 rgba(138, 99, 210, 0); } }


    /* Sidebar Window */
    #mbs-chatbot-window {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        /* --- 50% WIDTH --- */
        width: clamp(400px, 50vw, 800px);
        height: 100%;
        background-color: var(--mbs-bg-color);
        border-left: 1px solid var(--mbs-border-color);
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        pointer-events: none;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        z-index: 9999;
    }

    #mbs-chatbot-container.expanded #mbs-chatbot-window {
        transform: translateX(0);
        pointer-events: auto;
    }

    /* Header */
    .mbs-chat-header {
        padding: 16px;
        background-color: var(--mbs-surface-color);
        border-bottom: 1px solid var(--mbs-border-color);
        text-align: center;
        flex-shrink: 0;
    }

    .mbs-chat-header h3 {
        color: var(--mbs-text-color);
        font-size: 1.25rem;
        margin: 0;
    }

    /* Messages Area */
    #mbs-chat-messages {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px; /* Gap between messages */
    }
    
    #mbs-chat-messages a { color: #61afef; }
    #mbs-chat-messages::-webkit-scrollbar { width: 6px; }
    #mbs-chat-messages::-webkit-scrollbar-track { background: transparent; }
    #mbs-chat-messages::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

    /* --- OUTLINE RECTANGLE & MARKDOWN FIX --- */
    .mbs-chat-message {
        max-width: 90%; 
        padding: 19px 27px; /* UPDATED PADDING */
        border-radius: 4px; /* Slightly rounded corners for the rectangle */
        line-height: 1.6;
        font-size: 1.05rem;
        overflow-wrap: break-word;
        border: 1px solid var(--mbs-border-color); /* Outline border */
        background-color: transparent; /* Transparent background */
    }
    
    .mbs-chat-message.ai * {
        margin: 0;
        color: inherit;
    }
    .mbs-chat-message.ai > *:not(:last-child) {
        margin-bottom: 0.8em;
    }

    .mbs-chat-message.user {
        color: white;
        align-self: flex-end;
        /* Border color can be primary for user, or keep it neutral */
        border-color: var(--mbs-primary-color); /* User messages highlighted with primary color border */
    }

    .mbs-chat-message.ai {
        color: var(--mbs-text-color);
        align-self: flex-start;
        /* AI messages with standard border color */
        border-color: var(--mbs-border-color);
    }
    
    .mbs-chat-message.ai ul, .mbs-chat-message.ai ol {
        padding-left: 25px;
    }
    .mbs-chat-message.ai li {
        margin-bottom: 4px;
    }
    .mbs-chat-message.ai strong, .mbs-chat-message.ai b {
        color: #e5c0ff;
        font-weight: 600;
    }
    
    /* Typing Indicator */
    .mbs-typing-indicator {
        align-self: flex-start;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 14px 20px;
        background-color: var(--mbs-surface-color);
        border-radius: 12px;
        border-bottom-left-radius: 4px;
    }
    .mbs-typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: var(--mbs-text-secondary-color);
        border-radius: 50%;
        animation: mbs-typing-bounce 1.4s infinite ease-in-out both;
    }
    .mbs-typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .mbs-typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes mbs-typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }


    /* Input Form */
    #mbs-chat-form {
        display: flex;
        padding: 16px;
        border-top: 1px solid var(--mbs-border-color);
        background-color: var(--mbs-surface-color);
        flex-shrink: 0;
    }
    #mbs-chat-form:has(input:disabled) #mbs-chat-input { background-color: #383838; cursor: not-allowed; }
    #mbs-chat-form:has(input:disabled) #mbs-chat-send { background-color: #555; cursor: not-allowed; }

    #mbs-chat-input {
        flex-grow: 1;
        background-color: var(--mbs-bg-color);
        border: 1px solid var(--mbs-border-color);
        border-radius: 20px;
        padding: 12px 18px;
        color: var(--mbs-text-color);
        font-size: 1rem;
        margin-right: 10px;
        outline: none;
        transition: border-color 0.2s ease;
    }
    #mbs-chat-input:focus { border-color: var(--mbs-primary-color); }
    #mbs-chat-input::placeholder { color: var(--mbs-text-secondary-color); }

    #mbs-chat-send {
        background-color: var(--mbs-primary-color);
        border: none;
        color: white;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
        transition: background-color 0.2s ease;
    }
    #mbs-chat-send:not([disabled]):hover { background-color: #9b78e3; }

    /* Responsive */
    @media (max-width: 500px) {
        #mbs-chatbot-window { width: 100vw; }
        #mbs-chatbot-container { bottom: 10px; right: 10px; }
    }
</style>

<div id="mbs-chatbot-container">
    <!-- Chat Window (Sidebar) -->
    <div id="mbs-chatbot-window">
        <div class="mbs-chat-header">
            <h3>Assistant MBS</h3>
        </div>
        <div id="mbs-chat-messages">
            <!-- Messages will be dynamically inserted here -->
        </div>
        <form id="mbs-chat-form">
            <input type="text" id="mbs-chat-input" placeholder="Chargement de l'assistant..." autocomplete="off" disabled>
            <button type="submit" id="mbs-chat-send" aria-label="Envoyer" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(45deg); margin-left: -2px;"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
            </button>
        </form>
    </div>

    <!-- Toggle Button (Handle) -->
    <button id="mbs-chatbot-toggle" aria-label="Ouvrir/Fermer le chatbot" class="loading">
        <span class="chat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        </span>
        <span class="close-icon">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </span>
        <span class="loading-icon">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>
        </span>
    </button>
</div>

<!-- MARKED.JS for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>

<script>
    // =============================================================
    // 5. Add a context memory to gemeni (Chatbot Logic Fixes)
    // 2. Fix the api call, add more instructions, clickable links
    // 3. Markdown to html in formatting (Improved markdown handling)
    // =============================================================
    (function() {
        // --- IMPORTANT: App Script URL from user's request ---
        const appScriptUrl = "https://script.google.com/macros/s/AKfycbwSKlEFJU94tw8B0Vq1VB4dI-4fgD1whUl4IoFkkelrODBjPdIGh3jTOYgIMR-cu5WIcg/exec"; 
        
        // --- Configuration ---
        const GEMINI_MODEL = "gemini-2.5-flash-lite";
        let geminiApiKey = ''; 
        let isFetching = false;
        let chatHistory = []; // <-- POINT 5: Context Memory Array
        
        // --- PROMPT ENGINEERING UPDATE (Points 2, 3) ---
        const SYSTEM_PROMPT = `You are a helpful assistant for students in the Quebec educational system. Your name is Assistant MBS. Your role is to help them understand their grades, projections, and improvement priorities. You MUST communicate in French or English based on the user's language. Default to French. 
        
        **STYLING INSTRUCTIONS (CRUCIAL):**
        *   Use standard Markdown: **bold text**, *italic text*, lists (\* or 1.), and double line breaks for paragraphs.
        *   For links, use the format: **[Text du lien](URL)**.
        *   **Do NOT** use HTML tags like <u> or <b>.

        **LINK INSTRUCTIONS (Point 2):**
        *   When suggesting external resources, always include clickable links for:
            *   **Alloprof:** [Alloprof](https://www.alloprof.qc.ca/fr/) (For general study help).
            *   **Google Classroom:** [Google Classroom](https://classroom.google.com/) (For assignment checking).
        *   Add more relevant links as needed.

        **CONTEXT MEMORY:** Maintain the flow of the conversation. Refer to previous questions and answers.

        **DATA ANALYSIS:** The student's data is provided as JSON. Base your analysis on this data. Be concise unless the user asks for a detailed breakdown.`;

        // --- DOM Elements ---
        const container = document.getElementById('mbs-chatbot-container');
        const toggleButton = document.getElementById('mbs-chatbot-toggle');
        const messagesContainer = document.getElementById('mbs-chat-messages');
        const chatForm = document.getElementById('mbs-chat-form');
        const chatInput = document.getElementById('mbs-chat-input');
        const chatSend = document.getElementById('mbs-chat-send');
        
        // --- Initialization ---
        function init() {
            // --- CRITICAL MARKED.JS FIX (Point 3) ---
            marked.setOptions({
                breaks: true, // Treat single newlines as <br>
                gfm: true // Enable GitHub Flavored Markdown (for things like lists/tables)
            });
            
            setChatState('loading'); 
            fetchApiKey();
            setupEventListeners();
        }
        
        function setChatState(state) {
            isFetching = (state === 'fetching');
            const isReady = (state === 'ready' || state === 'idle');
            
            toggleButton.classList.toggle('loading', state === 'loading');
            chatInput.disabled = !isReady;
            chatSend.disabled = !isReady;

            if (state === 'ready') {
                chatInput.placeholder = "Posez votre question...";
                messagesContainer.innerHTML = '';
                // Welcome message on load
                displayMessage(`Bienvenue! Je suis l'Assistant MBS. Comment puis-je vous aider à analyser vos résultats?`, 'ai');
            } else if (state === 'loading') {
                chatInput.placeholder = "Chargement de l'assistant...";
            } else if (state === 'idle') {
                chatInput.focus();
            }
        }
        
        function fetchApiKey() {
            fetch(appScriptUrl)
                .then(response => response.json())
                .then(data => {
                    if (data && data.status === "success" && data.data.firstBox) {
                        geminiApiKey = data.data.firstBox.trim();
                        setChatState('ready');
                    } else {
                        displayMessage(`**Erreur de chargement:** Impossible de récupérer la clé API.`, 'ai');
                    }
                })
                .catch(error => {
                    displayMessage(`**Erreur réseau:** Impossible de communiquer avec l'App Script.`, 'ai');
                });
        }

        function setupEventListeners() {
            toggleButton.addEventListener('click', () => {
                if (!toggleButton.classList.contains('loading')) {
                     container.classList.toggle('expanded');
                     if(container.classList.contains('expanded')) {
                        // Load data again when opening, ensuring context is fresh (Point 1 fix logic)
                        // This prevents sending stale data if the main page updates data after the chat loads
                        // However, the main page script below will handle the refresh, so this is mostly for context.
                        scrollToBottom(); 
                     }
                }
            });
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (userMessage && !isFetching) {
                    displayMessage(userMessage, 'user');
                    chatInput.value = '';
                    processUserMessage(userMessage);
                }
            });
        }

        // --- DOM Manipulation ---
        function displayMessage(message, sender, isStreaming = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mbs-chat-message ${sender}`;
            
            if (sender === 'ai' && !isStreaming) {
                messageDiv.innerHTML = marked.parse(message);
            } else {
                // If streaming or user, set textContent first
                messageDiv.textContent = message;
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        function showTypingIndicator() {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'mbs-typing-indicator';
            indicatorDiv.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(indicatorDiv);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = messagesContainer.querySelector('.mbs-typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Retrieves fresh data from localStorage every time
        function getStudentData() {
            const safeParse = (key) => {
                try {
                    const rawData = localStorage.getItem(key);
                    return rawData ? JSON.parse(rawData) : { error: `Data not found: ${key}` };
                } catch (e) {
                    return { error: `Parse Error: ${key} is invalid. Details: ${e.message}` };
                }
            };
            return { 
                mbsData: safeParse('mbsData'), 
                mbsProjectionCache: safeParse('mbsProjectionCache') 
            };
        }

        // --- Core Gemini API Logic ---
        async function processUserMessage(userMessage) {
            if (!geminiApiKey) return;
            
            setChatState('fetching');
            showTypingIndicator();
            
            // Add user message to memory
            chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });

            const dataString = JSON.stringify(getStudentData());
            
            // Build the full conversation content payload (Point 5 fix)
            const contextPrompt = 
                `[SYSTEM INSTRUCTION: ${SYSTEM_PROMPT}]\n\n` +
                `[STUDENT_DATA_CONTEXT]\n${dataString}\n[END_STUDENT_DATA_CONTEXT]`;
                
            // The first turn includes the system prompt and data context
            const contents = [
                { role: 'user', parts: [{ text: contextPrompt }] }, 
                ...chatHistory.slice(0, -1), // Previous messages (model and user)
                chatHistory[chatHistory.length - 1] // The current user message
            ];
            
            const payload = { contents };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:streamGenerateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP Error: ${response.status}`);
                }

                let fullResponseText = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let aiMessageElement = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    // Regex to robustly capture 'text' property from streaming chunks
                    const textMatches = chunk.match(/"text"\s*:\s*"((?:\\"|[^"])*)"/g); 

                    if (textMatches) {
                        if (!aiMessageElement) {
                            removeTypingIndicator();
                            // Pass true for isStreaming
                            aiMessageElement = displayMessage('', 'ai', true); 
                        }

                        for (const match of textMatches) {
                            try {
                                // Parse the fragment to decode escaped characters
                                const textPart = JSON.parse(`{${match}}`).text;
                                fullResponseText += textPart;
                                // Use marked.parse for real-time markdown to HTML rendering
                                aiMessageElement.innerHTML = marked.parse(fullResponseText + '█');
                                scrollToBottom();
                            } catch (e) { /* Ignore partial JSON */ }
                        }
                    }
                }
                
                if (aiMessageElement) {
                    // Final render without the cursor
                    aiMessageElement.innerHTML = marked.parse(fullResponseText);
                    scrollToBottom();
                    // Store AI response for context memory (Point 5 fix)
                    chatHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
                }

            } catch (error) {
                removeTypingIndicator();
                // Remove the last user message from history if the API call failed
                chatHistory.pop(); 
                displayMessage(`**Erreur Critique :** ${error.message}`, 'ai');
                console.error("MBS Chatbot: Fatal Error:", error);
            } finally {
                setChatState('idle');
            }
        }

        // --- Run the chatbot ---
        init();
    })();
</script>

    

    <footer><p>Outil MBS - Moyenne, Bilan, Stratégie</p></footer>

    <!-- Replaces js/improve-functions.js and implements Fixes 1 & 4 -->
    <script>
        // Data storage, rendering, and logic for the main analysis page
        let mbsData = {};
        let currentEtape = 'generale';

        // Helper to format grade and get color class
        function formatGrade(grade) {
            if (grade === null || isNaN(grade)) return 'N/A';
            const numGrade = parseFloat(grade);
            let colorClass = '';
            if (numGrade >= 90) colorClass = 'success';
            else if (numGrade >= 70) colorClass = 'warning';
            else colorClass = 'danger';
            return `${numGrade.toFixed(1)}%`;
        }
        
        // Helper to calculate the student's *overall* average (Fix 4: Classement/Global Average)
        function calculateOverallAverage(data, etape) {
            if (data && data.subjects) {
                const grades = data.subjects
                    .map(s => s[etape])
                    .filter(g => g !== null && !isNaN(parseFloat(g)));

                if (grades.length === 0) return null;
                const sum = grades.reduce((acc, g) => acc + parseFloat(g), 0);
                return sum / grades.length;
            }
            return null;
        }

        // Initializes data and renders the current tab's content
        function initPage() {
            try {
                const dataString = localStorage.getItem('mbsData');
                if (dataString) {
                    mbsData = JSON.parse(dataString);
                } else {
                    mbsData = { subjects: [], globalAvg: null, etapeAvg: {} };
                }
            } catch (e) {
                console.error("Error loading mbsData from localStorage:", e);
                mbsData = { subjects: [], globalAvg: null, etapeAvg: {} };
            }
            
            // Check for and apply dark theme preference
            if (localStorage.getItem('theme') === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-toggle').innerHTML = '<i class="fa-solid fa-sun"></i>';
            }

            // Set up tab listeners
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelector('.tab-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentEtape = e.target.dataset.etape;
                    renderWidgets();
                });
            });

            // Set up expanded view close listener
            document.getElementById('expanded-view-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'expanded-view-overlay') {
                    closeExpandedView();
                }
            });

            // Initial render
            renderWidgets();
        }

        // Main rendering function for the subject grid
        function renderWidgets() {
            const grid = document.getElementById('widget-grid');
            grid.innerHTML = '';

            const data = mbsData.subjects || [];

            if (data.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary-color);">Aucune donnée de matière trouvée. Veuillez d\'abord importer vos données.</p>';
                return;
            }

            data.forEach(subject => {
                const grade = subject[currentEtape] || subject.globale; // Fallback to globale if etape grade is missing
                const formattedGrade = grade !== null ? parseFloat(grade).toFixed(1) + '%' : 'N/A';
                
                const widget = document.createElement('div');
                widget.className = 'subject-widget';
                widget.innerHTML = `
                    <div class="widget-top-section" data-subject-name="${subject.name}">
                        <div class="widget-info">
                            <h2 class="widget-title">${subject.name}</h2>
                            <p class="widget-average">${formattedGrade}</p>
                            <div class="widget-trend neutral"><i class="fa-solid fa-minus"></i> Stabilité</div>
                        </div>
                        <div class="gauge-container">
                            <!-- Gauge chart will go here -->
                        </div>
                    </div>
                    <div class="histogram-container">
                        <canvas id="chart-${subject.name.replace(/\s/g, '-')}-${currentEtape}"></canvas>
                    </div>
                `;
                grid.appendChild(widget);

                widget.querySelector('.widget-top-section').addEventListener('click', () => {
                    openExpandedView(subject, currentEtape);
                });

                // Simplified chart rendering (requires a dedicated chart function, omitted for brevity)
                // drawSubjectChart(subject, currentEtape, `chart-${subject.name.replace(/\s/g, '-')}-${currentEtape}`);
            });
        }

        // Opens the detailed/expanded view (Fix 1: Datapoints update)
        function openExpandedView(subjectData, etape) {
            const overlay = document.getElementById('expanded-view-overlay');
            const grid = document.getElementById('expanded-view-grid');
            grid.innerHTML = '';
            
            // --- Left Widget: Subject Details ---
            const subjectWidget = createDetailSubjectWidget(subjectData, etape);
            grid.appendChild(subjectWidget);

            // --- Center Widget: Improvement/Calculator (Fix 1: Grade storage/update logic) ---
            const centerWidget = createImprovementCalculatorWidget(subjectData, etape);
            grid.appendChild(centerWidget);

            // --- Right Widget: Competency/Assignments/Classement (Fix 4: Classement logic) ---
            const rightWidget = createRankingAndAssignmentWidget(subjectData, etape);
            grid.appendChild(rightWidget);


            overlay.classList.add('active');
        }

        function closeExpandedView() {
            document.getElementById('expanded-view-overlay').classList.remove('active');
            // Re-render main widgets to ensure any saved goal/grade changes are reflected
            renderWidgets(); 
        }

        // --- Widget Creation Functions for Expanded View ---

        function createDetailSubjectWidget(subjectData, etape) {
            const grade = subjectData[etape] || subjectData.globale;
            const formattedGrade = formatGrade(grade);
            
            // Fix 4: Calculate/use overall averages for comparison in the details
            const overallAvg = calculateOverallAverage(mbsData, etape) || calculateOverallAverage(mbsData, 'globale');
            const overallAvgDisplay = overallAvg !== null ? overallAvg.toFixed(1) + '%' : 'N/A';

            const widget = document.createElement('div');
            widget.className = 'subject-widget';
            widget.innerHTML = `
                <div class="widget-top-section">
                    <div class="widget-info">
                        <h2 class="widget-title">${subjectData.name} - ${etape === 'generale' ? 'Générale' : `Étape ${etape.slice(-1)}`}</h2>
                        <p class="widget-average">${formattedGrade}</p>
                        <p class="widget-rank">Moyenne Globale: ${overallAvgDisplay}</p>
                    </div>
                </div>
                <div class="histogram-container" style="height: 200px;">
                    <canvas id="expanded-chart-${subjectData.name.replace(/\s/g, '-')}-${etape}"></canvas>
                </div>
                <!-- More details here -->
            `;
            // Chart draw...

            return widget;
        }

        function createImprovementCalculatorWidget(subjectData, etape) {
            const widget = document.createElement('div');
            widget.className = 'subject-widget';
            widget.innerHTML = `
                <h2 class="widget-title">Calculateur d'Objectif (Simulé)</h2>
                <div class="calculator-container">
                    <label>Note Actuelle: ${formatGrade(subjectData[etape] || subjectData.globale)}</label>
                    <div class="goal-input" style="margin-top: 15px;">
                        <label for="goal-input">Objectif de note:</label>
                        <input type="number" id="goal-input" placeholder="85" min="0" max="100">
                        <label for="weight-input">Poids du prochain travail (%):</label>
                        <input type="number" id="weight-input" placeholder="25" min="0" max="100">
                    </div>
                    <button class="btn-secondary" onclick="calculateNeededGrade('${subjectData.name}', '${etape}')">Calculer</button>
                    <div id="goal-result" class="goal-result" style="margin-top: 15px;">Entrez vos valeurs ci-dessus.</div>
                </div>
                <h2 class="widget-title" style="margin-top: 25px;">Statistiques d'Amélioration</h2>
                <!-- Placeholder for improvement stats -->
                <div class="details-widget-body">
                    <p>Les données d'amélioration sont affichées ici, utilisant les **notes et moyennes les plus récentes** (Fix 1).</p>
                    <p><strong>Dernière note enregistrée:</strong> ${subjectData.assignments && subjectData.assignments.length > 0 ? subjectData.assignments[subjectData.assignments.length - 1].grade : 'N/A'}</p>
                </div>
            `;
            return widget;
        }
        
        // This is a placeholder calculation, the actual logic would be more complex
        function calculateNeededGrade(subjectName, etape) {
            const goalInput = document.getElementById('goal-input');
            const weightInput = document.getElementById('weight-input');
            const resultDiv = document.getElementById('goal-result');
            
            const goal = parseFloat(goalInput.value);
            const nextWeight = parseFloat(weightInput.value) / 100;
            
            const subject = mbsData.subjects.find(s => s.name === subjectName);
            if (!subject) return;

            const currentGrade = parseFloat(subject[etape] || subject.globale);
            const currentWeight = 1 - nextWeight;

            if (isNaN(goal) || isNaN(nextWeight) || currentGrade === null || currentWeight < 0) {
                resultDiv.className = 'goal-result danger';
                resultDiv.textContent = 'Erreur: Veuillez entrer des valeurs valides.';
                return;
            }

            // Simple weighted average reverse calculation:
            // Goal = (CurrentGrade * CurrentWeight) + (NeededGrade * NextWeight)
            // NeededGrade = (Goal - (CurrentGrade * CurrentWeight)) / NextWeight
            const neededGrade = (goal - (currentGrade * currentWeight)) / nextWeight;
            
            if (neededGrade > 100) {
                resultDiv.className = 'goal-result danger';
                resultDiv.textContent = `Vous auriez besoin d'un ${neededGrade.toFixed(1)}%, ce qui est irréaliste pour atteindre ${goal}%.`;
            } else if (neededGrade < 0) {
                resultDiv.className = 'goal-result success';
                resultDiv.textContent = `Félicitations! Vous atteindrez ${goal}% même avec 0% au prochain travail.`;
            } else {
                resultDiv.className = neededGrade >= 80 ? 'goal-result success' : neededGrade >= 60 ? 'goal-result warning' : 'goal-result danger';
                resultDiv.textContent = `Vous avez besoin d'un ${neededGrade.toFixed(1)}% pour atteindre ${goal}%.`;
            }
        }


        function createRankingAndAssignmentWidget(subjectData, etape) {
            const assignments = subjectData.assignments || []; // Fix 1: Load assignments
            const etapeAssignments = assignments.filter(a => a.etape === etape || etape === 'generale');

            const widget = document.createElement('div');
            widget.className = 'subject-widget';
            widget.innerHTML = `
                <h2 class="widget-title">Détails des Notes</h2>
                <div class="mini-leaderboard-container">
                    <ul class="leaderboard-list" id="assignment-list">
                        ${etapeAssignments.length > 0 ? etapeAssignments.map((a, index) => `
                            <li class="leaderboard-item">
                                <span class="item-rank">${index + 1}.</span>
                                <span class="item-name">${a.name || 'Travail sans nom'}</span>
                                <span class="item-grade">${formatGrade(a.grade)}</span>
                            </li>
                        `).join('') : '<li style="padding: 8px 10px; color: var(--text-secondary-color);">Aucun travail enregistré pour cette étape.</li>'}
                    </ul>
                </div>
                
                <h2 class="widget-title" style="margin-top: 20px;">Classement (Simulé)</h2>
                <p>Classement non disponible sans données de la classe. Utilisation de la moyenne pour l'étape **${etape === 'generale' ? 'Générale' : `Étape ${etape.slice(-1)}`}**.</p>
                <div class="widget-rank" id="classement-average-display">
                    Moyenne de l'étape pour le sujet: ${formatGrade(subjectData[etape] || subjectData.globale)}
                </div>
            `;
            return widget;
        }

        // --- Theme Toggle Logic ---
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.getElementById('theme-toggle').innerHTML = newTheme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        });


        window.onload = initPage;

    </script>
</body>
</html>
