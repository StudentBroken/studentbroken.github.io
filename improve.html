<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse - Outil MBS</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --transition-duration: 0.35s;
            --primary-color: #2980b9; --secondary-color: #2c3e50; --background-color: #f7f9fb;
            --widget-background: #ffffff; --text-color: #34495e; --text-secondary-color: #7f8c8d;
            --accent-color: #3498db; --border-color: #e0e6eb; --light-grey: #bdc3c7;
            --footer-grey: #7f8c8d; --success-color: #27ae60; --danger-color: #e74c3c;
            --warning-color: #f39c12; --shadow-header: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-widget: 0 8px 15px rgba(0,0,0,0.08); --goal-success-bg: #eafaf1;
            --goal-warning-bg: #fff9f0; --goal-danger-bg: #fdf3f2;
        }
        [data-theme="dark"] {
            --background-color: #121212; --widget-background: #1e1e1e; --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0; --secondary-color: #bbbbbb; --border-color: #333333;
            --light-grey: #757575; --footer-grey: #a0a0a0; --shadow-header: 0 2px 5px rgba(255,255,255,0.1);
            --shadow-widget: 0 5px 10px rgba(0,0,0,0.3); --goal-success-bg: #1a3e2a;
            --goal-warning-bg: #4d381c; --goal-danger-bg: #4f2323;
        }

        /* --- GLOBAL STYLES & TRANSITIONS --- */
        * { box-sizing: border-box; }
        body, .site-header-container, .subject-widget, .tab-btn, .popup-widget, .modal-content {
            transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease, border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); }

        /* --- HEADER & NAVIGATION --- */
        .site-header-container { background-color: var(--widget-background); box-shadow: var(--shadow-header); border-bottom: 1px solid var(--border-color); padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; flex: 1; }
        .header-right { justify-content: flex-end; }
        .site-header { flex: 2; text-align: center; color: var(--secondary-color); font-size: 2.2em; font-weight: 700; font-family: 'Playfair Display', serif; }
        .icon-btn { background: none; border: 2px solid var(--light-grey); color: var(--text-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1em; text-decoration: none; transition: all 0.2s ease; }
        .icon-btn:hover { border-color: var(--primary-color); color: var(--primary-color); transform: scale(1.1); }
        .btn-secondary { text-decoration: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; background-color: var(--primary-color); color: white; border: none; transition: all 0.2s ease; }
        .btn-secondary:hover { background-color: var(--accent-color); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .sticky-tabs { position: sticky; top: 0; background-color: var(--background-color); z-index: 100; padding: 15px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: 1px solid var(--light-grey); border-radius: 20px; background-color: transparent; color: var(--text-color); font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* --- MAIN WIDGET GRID --- */
        .widget-grid { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px; }
        .subject-widget { background-color: var(--widget-background); border-radius: 12px; box-shadow: var(--shadow-widget); padding: 20px; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .subject-widget:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }
        .widget-top-section { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .widget-info { flex: 1; }
        .widget-title { font-size: 1.2em; font-weight: 700; color: var(--secondary-color); margin: 0 0 10px 0; }
        .widget-average { font-size: 2.5em; font-weight: 700; color: var(--primary-color); margin: 0; }
        .widget-trend { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.9em; margin-top: 5px; }
        .widget-trend.up { color: var(--success-color); } .widget-trend.down { color: var(--danger-color); } .widget-trend.neutral { color: var(--text-secondary-color); }
        .gauge-container { width: 120px; height: 70px; position: relative; }
        .histogram-container { margin-top: 15px; height: 120px; }
        .widget-chart-controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 5px; height: 25px; gap: 5px; }
        .chart-toggle-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary-color); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8em; transition: all 0.2s ease; display: flex; align-items: center; }
        .chart-toggle-btn:hover { color: var(--primary-color); border-color: var(--primary-color); }
        
        /* --- POPUP VIEW STYLES --- */
        #popup-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; opacity: 0; transition: opacity 0.3s; }
        #popup-overlay.active { display: flex; opacity: 1; }
        .popup-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; width: 100%; max-width: 1200px; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #popup-overlay.active .popup-container { transform: scale(1); }
        .popup-widget { background-color: var(--widget-background); border-radius: 16px; padding: 25px; box-shadow: var(--shadow-widget); display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto; }
        .popup-double-chart-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; height: 150px; }
        #popup-subject-widget .widget-chart-controls { visibility: hidden; } /* Hide toggle for popup as both are shown */

        /* --- RANKING & LEADERBOARD STYLES --- */
        .mini-leaderboard-container { flex-grow: 1; overflow-y: auto; position: relative; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; max-height: 200px; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; }
        .leaderboard-item { display: flex; align-items: center; padding: 8px 10px; border-radius: 8px; font-size: 0.9em; transition: background-color 0.2s; }
        .leaderboard-item.is-user { background-color: #eaf2f8; font-weight: bold; }
        [data-theme='dark'] .leaderboard-item.is-user { background-color: #2c3e50; }
        .item-rank { width: 40px; font-weight: 600; } .item-name { font-weight: normal; } .item-grade { margin-left: auto; font-weight: 600; }
        #popup-ranking-widget .widget-title { text-align: center; }
        .ranking-chart-container { margin-top: 15px; height: 180px; }
        
        /* --- GHOST LOADER ANIMATION --- */
        @keyframes ghost-pulse { 0% { background-color: rgba(128, 128, 128, 0.1); } 50% { background-color: rgba(128, 128, 128, 0.2); } 100% { background-color: rgba(128, 128, 128, 0.1); } }
        .ghost-loader .gl-bar { animation: ghost-pulse 1.5s infinite ease-in-out; border-radius: 8px; }
        .ghost-loader .gl-title { width: 60%; height: 24px; margin: 0 auto 15px auto; }
        .ghost-loader .gl-text { width: 80%; height: 16px; margin: 10px auto; }
        .ghost-loader .gl-list-item { display: flex; gap: 10px; margin-bottom: 8px; }
        .ghost-loader .gl-list-item div { height: 20px; }
        .ghost-loader .gl-list-item .gl-rank { width: 40px; } .ghost-loader .gl-list-item .gl-name { flex: 1; } .ghost-loader .gl-list-item .gl-score { width: 50px; }
        .ghost-loader .gl-chart { width: 100%; height: 180px; margin-top: 20px; }

        /* --- GOAL CALCULATOR (in Popup) --- */
        .calculator-container { background-color: var(--background-color); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color); margin-top: 25px; }
        .goal-input { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .goal-input input { width: 80px; padding: 8px; border-radius: 6px; border: 1px solid var(--light-grey); text-align: center; font-size: 1.1em; }
        [data-theme="dark"] .goal-input input { background-color: #282828; color: var(--text-color); }
        .btn-save { padding: 8px 12px; border: none; background-color: var(--primary-color); color: white; border-radius: 6px; cursor: pointer; }
        .goal-result { padding: 15px; border-radius: 6px; text-align: center; font-size: 1em; font-weight: 600; }
        .goal-result.success { background-color: var(--goal-success-bg); color: var(--success-color); }
        .goal-result.warning { background-color: var(--goal-warning-bg); color: var(--warning-color); }
        .goal-result.danger { background-color: var(--goal-danger-bg); color: var(--danger-color); }
    </style>
</head>
<body>
    <header class="site-header-container">
        <div class="header-left">
            <a href="main.html" class="icon-btn" title="Retour au tableau de bord"><i class="fa-solid fa-arrow-left"></i></a>
        </div>
        <h1 class="site-header">Outil MBS</h1>
        <div class="header-right">
            <button id="theme-toggle" class="icon-btn" aria-label="Changer de th√®me"><i class="fa-solid fa-moon"></i></button>
            <a href="projection.html" class="btn btn-secondary">Projection</a>
        </div>
    </header>

    <div class="sticky-tabs">
        <button class="tab-btn active" data-etape="generale">G√©n√©rale</button>
        <button class="tab-btn" data-etape="etape1">√âtape 1</button>
        <button class="tab-btn" data-etape="etape2">√âtape 2</button>
        <button class="tab-btn" data-etape="etape3">√âtape 3</button>
    </div>

    <main id="widget-grid" class="widget-grid">
        <!-- Widgets will be populated by JavaScript -->
    </main>
    
    <!-- POPUP VIEW (Replaces Modal) -->
    <div id="popup-overlay">
        <div class="popup-container">
            <div id="popup-subject-widget" class="popup-widget"></div>
            <div id="popup-ranking-widget" class="popup-widget"></div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx1CoMUIieKjENe1jE-5It-pIEi7qiU2Mv6ian-3yDNs6uz383wlQYmCdDNXXHAgLjpGw/exec';
        const subjectNames = { 'ART':"Arts", 'MUS':"Musique", 'DRM':"Art Dram.", 'CAT':"Tech", 'FRA':"Fran√ßais", 'ELA':"Anglais", 'EESL':"Anglais Enrichi", 'ESL':"Anglais Second", 'SN':"Math SN", 'CST':"Math CST", 'ST':"Science", 'STE':"Science (STE)", 'HQC':"Histoire", 'CCQ':"Citoyennet√©", 'EPS':"√â. Phys.", 'CHI':"Chimie", 'PHY':"Physique", 'MON':"Monde Cont.", 'MED':"M√©dia", 'ENT':"Entreprenariat", 'INF':"Informatique", 'PSY':"Psychologie", 'FIN':"Finance" };

        let mbsData = {};
        let rankingData = { loading: true, data: null, error: null };
        let activePopupCharts = {};
        const activeWidgetCharts = {};

        const widgetGrid = document.getElementById('widget-grid');
        const popupOverlay = document.getElementById('popup-overlay');

        // --- INITIALIZATION ---
        function init() {
            mbsData = JSON.parse(localStorage.getItem('mbsData')) || {};
            if (!mbsData.valid) {
                widgetGrid.innerHTML = `<p style="text-align:center; grid-column: 1 / -1;">Aucune donn√©e. Veuillez <a href="data.html">importer vos donn√©es</a>.</p>`;
                return;
            }
            // Initialize nested settings objects to prevent errors
            mbsData.settings = mbsData.settings || {};
            mbsData.settings.chartViewPrefs = mbsData.settings.chartViewPrefs || {};
            mbsData.historique = mbsData.historique || {};

            setupEventListeners();
            fetchRankingData(); // Start fetching ranking data in the background
            renderWidgets('generale');
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
                document.querySelector('.tab-btn.active').classList.remove('active');
                btn.classList.add('active');
                renderWidgets(btn.dataset.etape);
            }));
            popupOverlay.addEventListener('click', e => { if (e.target === popupOverlay) closePopupView(); });
            
            // Theme Toggle
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            const toggleIcon = themeToggle.querySelector('i');
            const updateTheme = (theme) => {
                html.setAttribute('data-theme', theme);
                localStorage.setItem('mbs-theme', theme);
                toggleIcon.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            };
            const storedTheme = localStorage.getItem('mbs-theme');
            const initialTheme = storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            updateTheme(initialTheme);
            themeToggle.addEventListener('click', () => updateTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
        }

        // --- DATA FETCHING & PROCESSING ---
        async function fetchRankingData() {
            try {
                if (!mbsData.valid || !mbsData.nom || !mbsData.settings.niveau) throw new Error("Donn√©es locales de l'utilisateur manquantes.");
                
                const averages = calculateAveragesForRanking(mbsData);
                const encodedName = btoa(unescape(encodeURIComponent(mbsData.nom)));
                
                const formData = new FormData();
                formData.append('encodedName', encodedName);
                formData.append('secondaryLevel', mbsData.settings.niveau);
                for (const key in averages.term) { if (averages.term[key] !== null) formData.append(key, averages.term[key].toFixed(2)); }
                for (const key in averages.subjects) { if (averages.subjects[key] !== null) formData.append(key, averages.subjects[key].toFixed(2)); }
                
                await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`Erreur r√©seau: ${response.statusText}`);
                const data = await response.json();
                
                rankingData = { loading: false, data: data, error: null, userEncodedName: encodedName, userLevel: mbsData.settings.niveau };
                
                // If popup is already open, refresh its ranking view
                if (popupOverlay.classList.contains('active')) {
                    const subjectCode = document.getElementById('popup-subject-widget').dataset.subjectCode;
                    renderRankingWidgetContent(subjectCode);
                }
            } catch (error) {
                console.error("Erreur de classement:", error);
                rankingData = { loading: false, data: null, error: error.message };
            }
        }

        // --- WIDGET RENDERING (MAIN GRID) ---
        function renderWidgets(etapeKey) {
            widgetGrid.innerHTML = '';
            Object.values(activeWidgetCharts).forEach(chart => chart.destroy());
            
            const allSubjects = getAllSubjects();
            renderGeneralAverageWidget(etapeKey, allSubjects);
            
            let subjectsToRender = (etapeKey === 'generale') ? [...allSubjects.values()] : (mbsData[etapeKey] || []);
            
            subjectsToRender.forEach(subject => {
                const overallSubject = allSubjects.get(subject.code);
                if (!overallSubject) return;

                const overallAverage = calculateSubjectAverage(overallSubject);
                if (overallAverage === null) return;
                
                updateAverageHistory(subject.code, overallAverage); // Always use overall average for history
                const averageHistory = mbsData.historique[subject.code] || [];
                const trend = calculateTrend(averageHistory);

                const widget = document.createElement('div');
                widget.className = 'subject-widget';
                widget.dataset.subjectCode = subject.code;
                const chartCanvasId = `chart-${subject.code}-${etapeKey}`;

                widget.innerHTML = `
                    <div class="widget-top-section">
                        <div class="widget-info">
                            <h3 class="widget-title">${subject.name}</h3>
                            <p class="widget-average">${overallAverage.toFixed(2)}%</p>
                            <div class="widget-trend ${trend.class}"><span>${trend.direction}</span><span>${trend.change}</span></div>
                        </div>
                    </div>
                    <div class="widget-chart-controls">
                         <button class="chart-toggle-btn" title="Changer de vue"><i class="fa-solid fa-chart-line"></i></button>
                    </div>
                    <div class="histogram-container"><canvas id="${chartCanvasId}"></canvas></div>
                `;
                widgetGrid.appendChild(widget);

                const preferredView = mbsData.settings.chartViewPrefs[subject.code] || 'histogram';
                renderWidgetChart(chartCanvasId, overallSubject, preferredView);
            });
            localStorage.setItem('mbsData', JSON.stringify(mbsData));

            // Attach event listeners after rendering
            widgetGrid.querySelectorAll('.subject-widget').forEach(widget => {
                const subjectCode = widget.dataset.subjectCode;
                const subjectData = allSubjects.get(subjectCode);
                
                // Click on widget body opens popup
                widget.addEventListener('click', () => openPopupView(subjectData));

                // Click on toggle button changes chart view
                const toggleBtn = widget.querySelector('.chart-toggle-btn');
                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent opening popup
                    const currentView = mbsData.settings.chartViewPrefs[subjectCode] || 'histogram';
                    const newView = currentView === 'histogram' ? 'line' : 'histogram';
                    mbsData.settings.chartViewPrefs[subjectCode] = newView;
                    localStorage.setItem('mbsData', JSON.stringify(mbsData));
                    
                    const canvasId = widget.querySelector('canvas').id;
                    renderWidgetChart(canvasId, subjectData, newView);
                });
            });
        }

        function renderWidgetChart(canvasId, subject, view) {
            if (activeWidgetCharts[canvasId]) activeWidgetCharts[canvasId].destroy();
            const toggleBtn = document.getElementById(canvasId).closest('.subject-widget').querySelector('.chart-toggle-btn');

            if (view === 'line') {
                const history = mbsData.historique[subject.code] || [];
                activeWidgetCharts[canvasId] = createChart(canvasId, 'line', {
                    labels: history.map((_, i) => `M${i + 1}`),
                    datasets: [{ data: history, borderColor: '#3498db', pointBackgroundColor: '#3498db', tension: 0.1 }]
                }, { title: 'Historique des moyennes', xTicks: false });
                toggleBtn.innerHTML = `<i class="fa-solid fa-chart-column"></i>`;
            } else { // histogram
                const grades = subject.competencies.flatMap(c => c.assignments.map(a => getNumericGrade(a.result)).filter(g => g !== null));
                activeWidgetCharts[canvasId] = createDistributionChart(canvasId, grades, 'Distribution des notes');
                toggleBtn.innerHTML = `<i class="fa-solid fa-chart-line"></i>`;
            }
        }

        function renderGeneralAverageWidget(etapeKey, allSubjects) {
            const { average, subjectAverages } = calculateGeneralAverage(etapeKey, allSubjects);
            if (average === null) return;

            updateAverageHistory('general', average);
            const trend = calculateTrend(mbsData.historique.general || []);
            
            const widget = document.createElement('div');
            widget.className = 'subject-widget'; // Re-use styling
            widget.id = 'general-average-widget';
            const chartCanvasId = 'general-chart';

            widget.innerHTML = `
                <div class="widget-top-section">
                    <div class="widget-info">
                        <h3 class="widget-title">Moyenne G√©n√©rale (${etapeKey === 'generale' ? 'Toutes' : etapeKey.replace('e', '√â')})</h3>
                        <p class="widget-average">${average.toFixed(2)}%</p>
                        <div class="widget-trend ${trend.class}"><span>${trend.direction}</span><span>${trend.change}</span></div>
                    </div>
                </div>
                <div class="widget-chart-controls">
                     <button class="chart-toggle-btn" title="Changer de vue"><i class="fa-solid fa-chart-line"></i></button>
                </div>
                <div class="histogram-container"><canvas id="${chartCanvasId}"></canvas></div>
            `;
            widgetGrid.prepend(widget); // Add to the beginning

            const preferredView = mbsData.settings.chartViewPrefs['general'] || 'histogram';
            renderWidgetChart(chartCanvasId, { code: 'general', competencies: [] }, preferredView);
            
            // Override renderWidgetChart logic for this special case
            if (preferredView === 'histogram') {
                if (activeWidgetCharts[chartCanvasId]) activeWidgetCharts[chartCanvasId].destroy();
                activeWidgetCharts[chartCanvasId] = createDistributionChart(chartCanvasId, subjectAverages, 'Distribution des moyennes de cours');
            }
            
            widget.querySelector('.chart-toggle-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const currentView = mbsData.settings.chartViewPrefs['general'] || 'histogram';
                const newView = currentView === 'histogram' ? 'line' : 'histogram';
                mbsData.settings.chartViewPrefs['general'] = newView;
                localStorage.setItem('mbsData', JSON.stringify(mbsData));
                renderGeneralAverageWidget(etapeKey, allSubjects); // Re-render the whole widget to update data and view
            });
        }

        // --- POPUP VIEW LOGIC ---
        function openPopupView(subject) {
            document.body.style.overflow = 'hidden';
            popupOverlay.classList.add('active');

            renderSubjectWidgetContent(subject);
            renderRankingWidgetContent(subject.code.substring(0, 3));
        }

        function closePopupView() {
            document.body.style.overflow = '';
            popupOverlay.classList.remove('active');
            Object.values(activePopupCharts).forEach(chart => chart.destroy());
        }

        function renderSubjectWidgetContent(subject) {
            const container = document.getElementById('popup-subject-widget');
            container.dataset.subjectCode = subject.code;
            const overallAverage = calculateSubjectAverage(subject);
            const trend = calculateTrend(mbsData.historique[subject.code] || []);

            container.innerHTML = `
                <div class="widget-top-section">
                    <div class="widget-info">
                        <h3 class="widget-title">${subject.name}</h3>
                        <p class="widget-average">${overallAverage.toFixed(2)}%</p>
                        <div class="widget-trend ${trend.class}"><span>${trend.direction}</span><span>${trend.change}</span></div>
                    </div>
                    <div class="widget-chart-controls">
                        <!-- Button placeholder if needed later -->
                    </div>
                </div>
                <div class="popup-double-chart-container">
                    <div class="histogram-container"><canvas id="popup-dist-chart"></canvas></div>
                    <div class="histogram-container"><canvas id="popup-hist-chart"></canvas></div>
                </div>
                <div class="calculator-container"></div>
            `;
            
            // Render the two charts
            const grades = subject.competencies.flatMap(c => c.assignments.map(a => getNumericGrade(a.result)).filter(g => g !== null));
            const history = mbsData.historique[subject.code] || [];
            activePopupCharts['dist'] = createDistributionChart('popup-dist-chart', grades, 'Distribution des notes');
            activePopupCharts['hist'] = createChart('popup-hist-chart', 'line', {
                labels: history.map((_, i) => `M${i + 1}`),
                datasets: [{ data: history, borderColor: '#3498db', tension: 0.1 }]
            }, { title: 'Historique des moyennes', xTicks: false });

            setupGoalFramework(subject, container.querySelector('.calculator-container'));
        }

        function renderRankingWidgetContent(subjectCode) {
            const container = document.getElementById('popup-ranking-widget');
            if (rankingData.loading) {
                container.innerHTML = getGhostLoaderHTML();
                return;
            }
            if (rankingData.error) {
                container.innerHTML = `<p style="color:var(--danger-color)">Erreur de chargement du classement.</p>`;
                return;
            }

            const { data, userEncodedName, userLevel } = rankingData;
            const levelData = data.filter(d => d.secondaryLevel === userLevel);
            const currentUserData = levelData.find(d => d.encodedName === userEncodedName);
            const subjectKey = Object.keys(subjectNames).find(key => key === subjectCode);

            if (!currentUserData || !subjectKey || currentUserData[subjectKey] === undefined) {
                 container.innerHTML = `<h3 class="widget-title">${subjectNames[subjectKey] || 'Classement'}</h3><p>Pas assez de donn√©es pour √©tablir un classement.</p>`;
                 return;
            }
            
            const userValue = parseFloat(currentUserData[subjectKey]);
            const allScores = levelData.map(u => parseFloat(u[subjectKey])).filter(s => !isNaN(s));
            allScores.sort((a,b) => b - a);
            const rank = allScores.indexOf(userValue) + 1;
            const percentile = (allScores.length > 0) ? ((allScores.length - rank + 1) / allScores.length * 100) : 0;
            
            const getTrophy = r => r === 1 ? 'ü•á' : r === 2 ? 'ü•à' : r === 3 ? 'ü•â' : `#${r}`;
            const leaderboardItems = levelData
                .filter(u => u[subjectKey] && !isNaN(parseFloat(u[subjectKey])))
                .sort((a, b) => b[subjectKey] - a[subjectKey])
                .map((user, index) => {
                    const r = index + 1;
                    const isCurrentUser = user.encodedName === userEncodedName;
                    return `<li class="leaderboard-item ${isCurrentUser ? 'is-user' : ''}">
                                <span class="item-rank">${getTrophy(r)}</span>
                                <span class="item-name">${isCurrentUser ? 'Vous' : `Anonyme #${r}`}</span>
                                <span class="item-grade">${parseFloat(user[subjectKey]).toFixed(1)}%</span>
                            </li>`;
                }).join('');

            container.innerHTML = `
                <h3 class="widget-title">${subjectNames[subjectKey]} - Classement</h3>
                <div class="widget-rank" style="text-align:center;">
                    ${rank > 0 ? `${getTrophy(rank)} sur ${allScores.length} <span style="margin-left:8px;">(Top ${percentile.toFixed(1)}%)</span>` : 'Non class√©'}
                </div>
                <div class="mini-leaderboard-container"><ul class="leaderboard-list">${leaderboardItems}</ul></div>
                <div class="ranking-chart-container"><canvas id="popup-ranking-chart"></canvas></div>
            `;

            // Scroll to user
            const userItem = container.querySelector('.is-user');
            if (userItem) userItem.scrollIntoView({ block: 'center' });
            
            // Render ranking comparison chart
            const calculateGroupAvg = (etapeKey) => {
                const validGrades = levelData.map(u => u[etapeKey] ? parseFloat(u[etapeKey][subjectKey]) : null).filter(g => g !== null && !isNaN(g) && g > 0);
                return validGrades.length > 0 ? validGrades.reduce((a, b) => a + b, 0) / validGrades.length : null;
            };
            const getUserEtapeGrade = (etapeKey) => {
                const etapeData = mbsData[etapeKey]?.find(s => s.code.startsWith(subjectKey));
                return etapeData ? calculateSubjectAverage(etapeData) : null;
            };

            const userData = [getUserEtapeGrade('etape1'), getUserEtapeGrade('etape2'), getUserEtapeGrade('etape3')];
            const groupData = [calculateGroupAvg('Etape1'), calculateGroupAvg('Etape2'), calculateGroupAvg('Etape3')]; // This part is an estimation as backend structure is assumed

            activePopupCharts['ranking'] = createChart('popup-ranking-chart', 'line', {
                labels: ['√âtape 1', '√âtape 2', '√âtape 3'],
                datasets: [
                    { label: 'Votre Moyenne', data: userData, borderColor: '#27ae60', tension: 0.4 },
                    { label: 'Moyenne du Niveau', data: groupData, borderColor: '#e74c3c', tension: 0.4 }
                ]
            }, { title: `Performance par √âtape`, yMin: 50, yMax: 100 });
        }
        
        function getGhostLoaderHTML() {
            return `
                <div class="ghost-loader">
                    <div class="gl-bar gl-title"></div>
                    <div class="gl-bar gl-text"></div>
                    <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                        ${Array(4).fill(0).map(() => `<div class="gl-list-item"><div class="gl-bar gl-rank"></div><div class="gl-bar gl-name"></div><div class="gl-bar gl-score"></div></div>`).join('')}
                    </div>
                    <div class="gl-bar gl-chart"></div>
                </div>`;
        }

        // --- UTILITY & CALCULATION FUNCTIONS ---
        const getNumericGrade = result => { /* Unchanged from your JS */ const gradeMap={'A+':100,'A':95,'A-':90,'B+':85,'B':80,'B-':75,'C+':70,'C':65,'C-':60,'D+':55,'D':50,'E':45}; if(!result)return null;const t=result.trim();if(gradeMap[t])return gradeMap[t];const s=t.match(/(\d+[,.]?\d*)\s*\/\s*(\d+[,.]?\d*)/);if(s){const a=parseFloat(s[1].replace(',','.')),e=parseFloat(s[2].replace(',','.'));return e>0?a/e*100:null}return null;};
        const calculateAverage = assignments => { let total=0, weight=0; (assignments||[]).forEach(a=>{const g=getNumericGrade(a.result),w=parseFloat(a.pond);if(g!==null&&!isNaN(w)&&w>0){total+=g*w;weight+=w;}}); return weight>0?{avg:total/weight,w:weight}:null; };
        function calculateSubjectAverage(subject) { let total=0, weight=0; if(subject&&subject.competencies){subject.competencies.forEach(c=>{const m=c.name.match(/\((\d+)%\)/);if(!m)return;const w=parseFloat(m[1]),r=calculateAverage(c.assignments||[]);if(r){total+=r.avg*w;weight+=w;}});}; return weight>0?total/weight:null; }
        function calculateGeneralAverage(etapeKey, allSubjects) {
            let subjectsToAvg = (etapeKey === 'generale') ? [...allSubjects.values()] : (mbsData[etapeKey] || []);
            const subjectAverages = subjectsToAvg.map(s => calculateSubjectAverage(allSubjects.get(s.code))).filter(avg => avg !== null);
            if (subjectAverages.length === 0) return { average: null, subjectAverages: [] };
            const average = subjectAverages.reduce((a, b) => a + b, 0) / subjectAverages.length;
            return { average, subjectAverages };
        }
        function getAllSubjects() { const map=new Map();['etape1','etape2','etape3'].forEach(e=>{ (mbsData[e]||[]).forEach(s=>{if(!map.has(s.code))map.set(s.code,{...s,competencies:[]});});});['etape1','etape2','etape3'].forEach(e=>{ (mbsData[e]||[]).forEach(s=>{map.get(s.code)?.competencies.push(...s.competencies);});}); return map; }
        function updateAverageHistory(code, avg) { const h=mbsData.historique[code]||[];if(h.length>0&&h[h.length-1]?.toFixed(2)===avg.toFixed(2))return;h.push(avg);while(h.length>10)h.shift();mbsData.historique[code]=h; }
        function calculateTrend(history) { if (history.length<2)return{direction:'‚Äî',change:'0.00%',class:'neutral'};const [prev,curr]=history.slice(-2),c=curr-prev;return c<0?{direction:'‚ñº',change:`${c.toFixed(2)}%`,class:'down'}:{direction:'‚ñ≤',change:`+${c.toFixed(2)}%`,class:'up'}; }
        function calculateAveragesForRanking(data) { /* Adapted from your ranking JS */ let t={GlobalAverage:null,Etape1Average:null,Etape2Average:null,Etape3Average:null},s={},c={};const w={e1:0.2,e2:0.2,e3:0.6};['etape1','etape2','etape3'].forEach(e=>{if(!data[e])return;let a=[];data[e].forEach(b=>{let t=0,w=0;b.competencies.forEach(d=>{const m=d.name.match(/\((\d+)%\)/);if(!m)return;const p=parseFloat(m[1]);let ct=0,ca=0;d.assignments.forEach(a=>{const g=getNumericGrade(a.result),w=parseFloat(a.pond);if(g!==null&&!isNaN(w)&&w>0){ct+=g*w;ca+=w;}});if(ca>0){t+=(ct/ca)*(p/100);w+=p/100;}});if(w>0){const avg=t/w;a.push(avg);const code=b.code.substring(0,3);s[code]=(s[code]||0)+avg;c[code]=(c[code]||0)+1;}});if(a.length>0){const k='Etape'+e.slice(-1)+'Average';t[k]=a.reduce((x,y)=>x+y,0)/a.length;}});for(const code in s){s[code]/=c[code];}let gt=0,gw=0;if(t.Etape1Average!==null){gt+=t.Etape1Average*w.e1;gw+=w.e1;}if(t.Etape2Average!==null){gt+=t.Etape2Average*w.e2;gw+=w.e2;}if(t.Etape3Average!==null){gt+=t.Etape3Average*w.e3;gw+=w.e3;}if(gw>0)t.GlobalAverage=gt/gw;return{term:t,subjects:s}; }
        
        // --- CHART CREATION HELPERS ---
        function createChart(canvasId, type, data, options = {}) { const ctx=document.getElementById(canvasId).getContext('2d'); return new Chart(ctx,{type,data,options:{responsive:true,maintainAspectRatio:false,scales:{y:{suggestedMin:options.yMin,suggestedMax:options.yMax},x:{ticks:{display:options.xTicks??true},grid:{display:options.xGrid??true}}},plugins:{legend:{display:false},title:{display:true,text:options.title}}}}); }
        function createDistributionChart(canvasId, grades, title) { const isDark=document.documentElement.getAttribute('data-theme')==='dark';const colors=isDark?['#ff5252','#ff9800','#cddc39','#4caf50']:['#e74c3c','#f39c12','#a0c800','#27ae60'];const bins={'<60':0,'60-69':0,'70-89':0,'90+':0};grades.forEach(g=>{if(g<60)bins['<60']++;else if(g<70)bins['60-69']++;else if(g<90)bins['70-89']++;else bins['90+']++;});return createChart(canvasId,'bar',{labels:Object.keys(bins),datasets:[{data:Object.values(bins),backgroundColor:colors}]},{title,yTicksStep:1});}
        
        // --- GOAL FRAMEWORK (in Popup) ---
        function setupGoalFramework(subject, container) { container.innerHTML=`<h4>Planificateur d'Objectifs</h4><div class="goal-input"><label>Objectif:</label><input type="number" id="objective-input" min="0" max="100" value="${mbsData.settings.objectives?.[subject.code]||''}"/>%<button class="btn-save">Sauver</button></div><div id="goal-result" class="goal-result"></div>`;const i=container.querySelector('input'),b=container.querySelector('button');b.addEventListener('click',()=>{const v=parseFloat(i.value);if(!isNaN(v)&&v>=0&&v<=100){mbsData.settings.objectives[subject.code]=v;}else{delete mbsData.settings.objectives[subject.code];}localStorage.setItem('mbsData',JSON.stringify(mbsData));b.textContent='Sauv√©!';setTimeout(()=>b.textContent='Sauver',1500);});const r=container.querySelector('#goal-result');function calc(){let s=0,c=0,f=0,t=0;subject.competencies.forEach(p=>p.assignments.forEach(a=>{const w=parseFloat(a.pond);if(isNaN(w)||w<=0)return;t+=w;const g=getNumericGrade(a.result);if(g!==null){s+=g*w;c+=w;}else{f+=w;}}));if(f<=0){r.style.display='none';return;}const o=parseFloat(i.value);if(isNaN(o)||o<0||o>100){r.innerHTML='Entrez un objectif valide.';r.className='goal-result danger';return;}const n= (o*t-s)/f;let m,cl;if(n>100.01){m=`Il faudrait <strong>${n.toFixed(1)}%</strong>. Impossible.`;cl='danger';}else if(n<0){m='Objectif d√©j√† atteint !';cl='success';}else{m=`Il vous faut <strong>${n.toFixed(1)}%</strong> sur le reste.`;cl='warning';}r.innerHTML=m;r.className=`goal-result ${cl}`;}i.addEventListener('input',calc);calc();}
        
        // --- START THE APP ---
        init();
    });
    </script>
</body>
</html>
