<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur Dynamique V10 (Pathfinder V2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* === BASE THEME VARIABLES (Based on Outil MBS) === */
        :root {
            /* Core Colors */
            --primary-color: #2980b9;    /* Blue for main actions/emphasis (replaces violet) */
            --secondary-color: #2c3e50;  /* Dark text/header color */
            --accent-color: #3498db;     /* Lighter primary color */
            
            /* Backgrounds & Text (Light Mode) */
            --background-color: #f7f9fb; /* Main body background */
            --widget-background: #ffffff;/* Card/Panel background */
            --text-color: #34495e;       /* Main text */
            --text-secondary-color: #7f8c8d; /* Subdued text */
            --light-grey: #e0e6eb;       /* Border/separator/light bg */
            
            /* Status/Alert Colors */
            --success-color: #27ae60;    /* Green */
            --danger-color: #e74c3c;     /* Red */
            --warning-color: #f39c12;    /* Orange/Amber */

            /* Specific Backgrounds */
            --goal-success-bg: #eafaf1; 
            --goal-warning-bg: #fff9f0; 
            --goal-danger-bg: #fdf3f2; 

            --shadow-widget: 0 8px 15px rgba(0,0,0,0.08); 
            --border-color: #e0e6eb;
            --transition-duration: 0.35s;
        }

        /* === DARK THEME VARIABLES & OVERRIDES === */
        [data-theme="dark"] {
            --background-color: #121212; 
            --widget-background: #1e1e1e;
            --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0;
            --light-grey: #333333;
            --border-color: #333333;
            --secondary-color: #bbbbbb; /* Dark mode secondary color for contrast */
            
            --goal-success-bg: #1a3e2a;
            --goal-warning-bg: #4d381c;
            --goal-danger-bg: #4f2323;

            --shadow-widget: 0 5px 10px rgba(0,0,0,0.3);
        }

        /* === GENERAL STYLES & TRANSITIONS (Apply to all relevant components) === */
        body, .side-panel, .tab-content, .modal-content, .tab-btn, select, input, .score-card, .prediction-card, .ai-insight-box, .subject-table, .help-btn, .back-to-main-btn, .gauge-needle, .bg-violet-100 {
            transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease, border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease, transform 0.2s ease; /* Added transform for hover */
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
        }

        /* Core Widget Styles - Use Variables */
        .side-panel, .tab-content, .modal-content, .score-card, .prediction-card {
            background-color: var(--widget-background);
            box-shadow: var(--shadow-widget);
        }

        /* Header / Title Styling */
        .content-area h1, .side-panel h2, .side-panel h3 {
            color: var(--secondary-color);
        }

        /* Tab Buttons */
        .tab-btn {
            background-color: var(--light-grey);
            color: var(--text-color);
        }
        .tab-btn.active {
            background-color: var(--widget-background);
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: none; /* Override Tailwind shadow */
        }
        
        /* Table / Border Styling */
        .subject-table thead th {
            background-color: var(--primary-color);
        }
        .subject-table tbody tr:nth-child(even) {
            background-color: var(--background-color); /* Lighter contrast in Light Mode */
        }
        .subject-table td, .probability-table th, .probability-table td {
            border-color: var(--border-color);
        }
        .grade-percentage {
            color: var(--primary-color);
        }
        
        /* Prediction/Analysis Cards & Boxes */
        .bg-violet-100, .subject-analysis, .ai-insight-box {
            background-color: var(--background-color); /* Ensure they blend more with the body bg in light mode */
            border-color: var(--border-color);
        }
        .prediction-card {
            background-color: var(--background-color); /* Ensure it's not too dark in light mode */
            border-left-width: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,.05);
        }
        .card-green { border-left-color: var(--success-color); }
        .card-violet { border-left-color: var(--primary-color); }
        .card-yellow { border-left-color: var(--warning-color); }
        .card-red { border-left-color: var(--danger-color); }

        /* Icon Buttons (Help/Theme/Back) */
        .help-btn, .back-to-main-btn {
            background-color: var(--secondary-color);
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .help-btn:hover, .back-to-main-btn:hover {
            transform: scale(1.1); /* Simplified hover animation */
            background-color: var(--primary-color);
            box-shadow: 0 6px 15px rgba(0,0,0,.3);
        }

        /* Gauge Needle */
        .gauge-needle {
            background-color: var(--secondary-color);
            border: 1px solid var(--widget-background);
        }

        /* === DARK MODE OVERRIDES (Applying Theme Variables) === */
        [data-theme="dark"] body { 
            color: var(--text-color); 
        }
        [data-theme="dark"] .content-area h1, [data-theme="dark"] .side-panel h2, [data-theme="dark"] .side-panel h3,
        [data-theme="dark"] .text-gray-800, [data-theme="dark"] .text-gray-700, [data-theme="dark"] .text-gray-600, 
        [data-theme="dark"] .text-gray-500, [data-theme="dark"] .score-card strong {
            color: var(--text-color) !important;
        }
        [data-theme="dark"] .text-gray-500, [data-theme="dark"] .gauge-labels span, [data-theme="dark"] .text-sm.text-gray-600 {
            color: var(--text-secondary-color) !important;
        }

        /* Widgets/Panels/Modals */
        [data-theme="dark"] .side-panel, [data-theme="dark"] .tab-content, [data-theme="dark"] .modal-content {
            background-color: var(--widget-background);
        }
        [data-theme="dark"] .subject-table tbody tr:nth-child(even), [data-theme="dark"] .score-card, [data-theme="dark"] .prediction-card, 
        [data-theme="dark"] .tab-btn, [data-theme="dark"] .bg-violet-100, [data-theme="dark"] .ai-insight-box, [data-theme="dark"] .subject-analysis,
        [data-theme="dark"] select, [data-theme="dark"] input[type="range"], [data-theme="dark"] #unites-btn {
            background-color: #2a2a2a !important; /* Slightly darker than widget bg for separation */
            color: var(--text-color);
        }

        /* Borders and Separators */
        [data-theme="dark"] .subject-table td, [data-theme="dark"] .probability-table th, [data-theme="dark"] .probability-table td,
        [data-theme="dark"] .border-b, [data-theme="dark"] .border-t, [data-theme="dark"] .border-l-4, [data-theme="dark"] .border {
            border-color: var(--border-color) !important;
        }
        
        /* Tab Fixes */
        [data-theme="dark"] .tab-btn.active {
            background-color: var(--widget-background);
            color: var(--primary-color);
        }
        
        /* Table Header Fixes */
        [data-theme="dark"] .subject-table thead th {
             background-color: var(--primary-color);
             color: white;
        }
        [data-theme="dark"] .bg-gray-100 { /* For probability table header */
            background-color: #3a3a3a !important;
        }
        
        /* Probability Table Status Colors */
        [data-theme="dark"] .prob-high { background-color: var(--goal-success-bg) !important; color: var(--success-color) !important; }
        [data-theme="dark"] .prob-medium { background-color: var(--goal-warning-bg) !important; color: var(--warning-color) !important; }
        [data-theme="dark"] .prob-low { background-color: var(--goal-danger-bg) !important; color: var(--danger-color) !important; }

        /* Badge/Pill Colors (Using Dark Mode Goal Colors) */
        [data-theme="dark"] .badge-green { background-color: var(--goal-success-bg) !important; color: var(--success-color) !important; }
        [data-theme="dark"] .badge-yellow { background-color: var(--goal-warning-bg) !important; color: var(--warning-color) !important; }
        [data-theme="dark"] .badge-red { background-color: var(--goal-danger-bg) !important; color: var(--danger-color) !important; }
        [data-theme="dark"] .badge-violet { background-color: #3a226d !important; color: #E9D5FF !important; }
        [data-theme="dark"] .badge-blue { background-color: #1e3a8a !important; color: #DBEAFE !important; }
        [data-theme="dark"] .badge-orange { background-color: #612c0a !important; color: #FFEDD5 !important; }

        /* Prediction Card Border Overrides (Use new variable colors) */
        [data-theme="dark"] .card-green { border-left-color: var(--success-color) !important; }
        [data-theme="dark"] .card-violet { border-left-color: var(--primary-color) !important; }
        [data-theme="dark"] .card-yellow { border-left-color: var(--warning-color) !important; }
        [data-theme="dark"] .card-red { border-left-color: var(--danger-color) !important; }
        
        /* Text Colors for status scores */
        [data-theme="dark"] .text-red-600 { color: var(--danger-color) !important; }
        [data-theme="dark"] .text-orange-600 { color: var(--warning-color) !important; }

    </style>
</head>
<body>

<!-- BACK BUTTON MODIFICATION: href changed from main.html to improve.html -->
<a href="improve.html" class="back-to-main-btn" title="Retour √† la page d'am√©lioration">
    <i class="fa-solid fa-arrow-left"></i>
</a>

<!-- THEME TOGGLE BUTTON -->
<button id="theme-toggle" class="help-btn" title="Changer de th√®me" style="right: 50px;">
    <!-- Icon will be set by the inline script -->
    <i class="fa-solid fa-moon"></i> 
</button>

<a id="open-help-btn" class="help-btn" title="Comment √ßa marche ?">
    <i class="fa-solid fa-question"></i>
</a>

<!-- ... (Rest of the HTML content remains the same) ... -->
<div id="help-modal" class="modal">
    <div class="modal-content">
        <span id="close-help-modal" class="modal-close">&times;</span>
        <h2 class="help-title">Guide D√©taill√© de l'Analyseur</h2>
        
        <p>Cet outil analyse votre <b>tendance</b> (votre "√©lan") et votre <b>volatilit√©</b> (votre stabilit√©) pour pr√©dire vos performances. Voici ce que chaque terme signifie en d√©tail.</p>

        <h3 class="help-section-title">Section Sp√©ciale : La R√©gression Lin√©aire (Le C≈ìur de l'IA)</h3>
        
        <h4>Qu'est-ce que c'est ?</h4>
        <p>Le "Moteur de D√©couverte (IA)" utilise un outil statistique appel√© <b>R√©gression Lin√©aire</b>. Son but est de trouver la "ligne de tendance" (la ligne droite de meilleur ajustement) qui passe au milieu d'un nuage de points de donn√©es. 

</p>
        <p>L'IA n'analyse pas seulement vos notes, elle analyse la <b>relation</b> entre deux variables. L'application effectue 3 analyses de r√©gression distinctes :</p>
        
        <ol class="detailed-list">
            <li><b>Mod√®le 1 : TENDANCE (Note vs. Temps)</b>
                <ul>
                    <li><b>(Axe X) :</b> Le temps (Devoir 1, Devoir 2, Devoir 3...)</li>
                    <li><b>(Axe Y) :</b> La note obtenue (85%, 88%, 87%...)</li>
                    <li><b>Ce qu'elle cherche :</b> "Est-ce que vos notes <b>montent</b> ou <b>baissent</b> avec le temps ?" C'est votre √©lan, ou "pente". C'est ce qui alimente le "Facteur de Tendance Globale".</li>
                </ul>
            </li>
            <li><b>Mod√®le 2 : FOCUS (Note vs. Pond√©ration du Devoir)</b>
                <ul>
                    <li><b>(Axe X) :</b> L'importance du devoir (Ex: 5%, 10%, 40%...)</li>
                    <li><b>(Axe Y) :</b> La note obtenue (95%, 90%, 82%...)</li>
                    <li><b>Ce qu'elle cherche :</b> "Avez-vous tendance √† mieux r√©ussir les <b>petits devoirs</b> ou les <b>gros examens</b> ?" Une pente n√©gative ici est un signal d'alarme : cela signifie que plus un examen est important, plus votre note a tendance √† baisser.</li>
                </ul>
            </li>
            <li><b>Mod√®le 3 : PRIORIT√â (Note vs. Pond√©ration de la Comp√©tence)</b>
                <ul>
                    <li><b>(Axe X) :</b> L'importance de la comp√©tence (Ex: 30%, 40%, 60%...)</li>
                    <li><b>(Axe Y) :</b> La note obtenue dans cette comp√©tence (90%, 85%, 80%...)</li>
                    <li><b>Ce qu'elle cherche :</b> "√ätes-vous meilleur dans les comp√©tences mineures ou majeures ?"</li>
                </ul>
            </li>
        </ol>

        <h4>Ce qui INFLUENCE la R√©gression (Votre question)</h4>
        <p>La "ligne de tendance" est comme une balan√ßoire. Ce qui l'influence le plus, ce sont les <b>points aberrants (Outliers)</b> et la <b>dispersion</b> de vos notes.</p>
        <ul>
            <li><b>Les Points Aberrants (Outliers) :</b> C'est l'influence n¬∞1. Si vous avez une moyenne de 90% mais que vous tombez malade et obtenez <b>20%</b> √† un examen, ce seul point tirera la "ligne de tendance" <b>massivement</b> vers le bas. L'IA verra cela comme une forte tendance n√©gative. De m√™me, un 100% facile sur un devoir tirera la ligne vers le haut.</li>
            <li><b>La Fiabilit√© (Le R¬≤) :</b> C'est le "Niveau de Confiance" de l'IA. C'est la statistique la plus importante que l'IA regarde.
                <ul>
                    <li>Un <b>R¬≤ √©lev√© (ex: 0.8 ou 80%)</b> signifie que vos notes sont tr√®s proches de la ligne de tendance. Le sch√©ma est <b>fiable</b>. L'IA peut affirmer avec certitude "Vous √™tes en hausse".</li>
                    <li>Un <b>R¬≤ faible (ex: 0.1 ou 10%)</b> signifie que vos notes sont "erratiques" et totalement dispers√©es autour de la ligne. Le sch√©ma est <b>non fiable</b>. C'est √† ce moment que l'IA vous dit : <b>"Je n'ai trouv√© aucun sch√©ma fiable"</b>, car la tendance qu'elle a trouv√©e n'explique que 10% de vos r√©sultats.</li>
                </ul>
            </li>
            <li><b>Le Nombre de Points (N) :</b> Une tendance sur 3 devoirs ne veut rien dire. Une tendance sur 30 devoirs est un sch√©ma tr√®s fort. C'est pourquoi l'IA ignore les mati√®res avec moins de 5 notes.</li>
        </ul>

        <h3 class="help-section-title">Panneau Principal (Gauche)</h3>
        
        <h4>Pr√©diction Globale Stochastique (Tendance MC)</h4>
        <p>"MC" signifie <b>Monte Carlo</b>. L'outil simule <b>100 000 sc√©narios possibles</b> pour l'√âtape 3. Chaque simulation est un "jet de d√©" bas√© sur :</p>
        <ol>
            <li><b>Votre moyenne projet√©e</b> (bas√©e sur la <b>Pente</b> de votre R√©gression Lin√©aire "Tendance").</li>
            <li><b>Votre volatilit√©</b> (votre <b>√âcart-Type</b>, ou "StdDev"). Un √©tudiant stable (faible volatilit√©) aura des simulations group√©es (ex: 88-92%). Un √©tudiant erratique (haute volatilit√©) aura des simulations dispers√©es (ex: 70-100%).</li>
        </ol>
        <p>Le score affich√© est le <b>P50 (M√©dian)</b> : le point exact o√π 50 000 simulations ont fait pire et 50 000 ont fait mieux. C'est le r√©sultat le plus probable.</p>

        <h4>Jauge de Performance (P5 √† P95)</h4>
        <p>C'est la carte compl√®te des 100 000 simulations :</p>
        <ul>
            <li><b>P5 (Pessimiste) :</b> 95 000 simulations ont donn√© un meilleur score. C'est votre "pire" sc√©nario probable.</li>
            <li><b>P50 (M√©dian) :</b> Le centre, identique √† la pr√©diction "Tendance MC".</li>
            <li><b>P95 (Optimiste) :</b> Seulement 5 000 simulations ont fait mieux. C'est le sc√©nario "r√™v√©".</li>
        </ul>

        <h4>Indices de Risque Dynamique</h4>
        <ul>
            <li><b>Indice de Consistance :</b> C'est l'inverse de votre <b>Volatilit√© (√âcart-Type)</b>. Un score de 100 signifie un √âcart-Type de 0 (ex: 90%, 90%, 90%). Un score bas signifie que vos notes sont tr√®s dispers√©es (ex: 60%, 100%, 75%).</li>
            <li><b>Risque de Burnout :</b> Score (sur 100) bas√© sur 4 facteurs : <b>1.</b> Volatilit√© (l'instabilit√© est stressante), <b>2.</b> Tendance (une pente n√©gative est un signe de difficult√©), <b>3.</b> Charge de travail (Unit√©s), <b>4.</b> Absent√©isme.</li>
            <li><b>Facteur de Tendance Globale :</b> C'est la <b>Pente (Slope)</b> de votre R√©gression "Tendance" x 10. (Ex: Pente de +0.2 = +2.0% F.T.G. = Vous gagnez 0.2 points par devoir, ou 2 points tous les 10 devoirs).</li>
        </ul>

        <h3 class="help-section-title">Analyse D√©taill√©e (Droite)</h3>

        <h4>Analyse de D√©s√©quilibre (Mismatch)</h4>
        <p>Cette section identifie les mati√®res "risqu√©es". Le "Score Mismatch" est √©lev√© si une mati√®re a :</p>
        <ul>
            <li><b>1. Une haute Volatilit√© (√âcart-Type) :</b> Vos notes sont tr√®s dispers√©es.</li>
            <li><b>2. Une faible Consistance :</b> Vos notes sont impr√©visibles.</li>
        </ul>
        <p>Une mati√®re "Rouge" (Mismatch √©lev√©) est une bombe √† retardement. C'est l√† que vous devez vous concentrer pour <b>stabiliser</b> vos r√©sultats (ex: visez des 80-90 constants plut√¥t que des 70-100 altern√©s).</p>

        <h4>Analyse de Chemin (Probabilit√©s)</h4>
        <p>Cette section vous donne un plan d'action. Elle r√©pond √† deux questions : <b>1.</b> "De quelle moyenne ai-je besoin ?" et <b>2.</b> "Quelles sont mes chances de l'obtenir ?"</p>
        <ul>
            <li><b>Moyenne Requise E2/E3 :</b> C'est un calcul alg√©brique simple pour d√©terminer la note exacte que vous devez obtenir √† l'√©tape 2 (ou 3) pour atteindre un objectif global.</li>
            <li><b>Probabilit√© (%) :</b> C'est la partie la plus importante. L'outil utilise la <b>Distribution Normale (CDF)</b>. Il compare la "Moyenne Requise" √† votre "Jauge de Performance (P5-P95)".</li>
            <li><b>Exemple :</b> Si votre "Moyenne Requise" est de <b>80%</b>, mais que votre jauge P5-P95 est entre 85% et 95%, votre probabilit√© de l'atteindre sera tr√®s √©lev√©e (ex: 99%), car 80% est en dessous de votre "pire" sc√©nario. Si la "Moyenne Requise" est de <b>96%</b>, elle est au-dessus de votre P95, donc la probabilit√© sera tr√®s faible (ex: <5%).</li>
        </ul>
    </div>
</div>

<div class="main-container">

    <div class="side-panel lg:sticky lg:top-4">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Moteur Stochastique V10 (Fix)</h2>

        <div class="bg-violet-100 p-4 rounded-lg mb-4 border-l-4 border-violet-600">
            <p class="text-sm font-medium text-gray-700">Pr√©diction Globale Stochastique (Tendance MC)</p>
            <strong id="moyenne-prediction" class="text-4xl font-extrabold text-violet-700">--</strong>
        </div>

        <h3 class="text-lg font-semibold text-gray-800">Jauge de Performance (P5 √† P95)</h3>
        <div class="gauge-container">
            <div class="gauge-bar">
                <!-- Color gradient needs to be updated to match the new theme if possible -->
                <div id="gauge-needle" class="gauge-needle" style="left: 50%;"></div>
            </div>
            <div class="gauge-labels">
                <span id="gauge-label-p5">P5: --%</span>
                <strong id="gauge-label-p50" class="text-primary-color">P50: --%</strong>
                <span id="gauge-label-p95">P95: --%</span>
            </div>
        </div>
        
        <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-800 border-b pb-2">Indices de Risque Dynamique</h3>
        <div id="deep-analysis-scorecard" class="space-y-3 mb-6">
            <div class="score-card score-high" id="consistency-score">
                <span class="score-icon text-gray-600">üéØ</span>
                <div>
                    <p class="text-sm font-medium text-gray-500">Indice de Consistance/Volatilit√© (100 = Parfait)</p>
                    <strong class="text-xl text-gray-800">--</strong>
                </div>
            </div>
            <div class="score-card score-low" id="burnout-risk-score">
                <span class="score-icon text-red-600">üî•</span>
                <div>
                    <p class="text-sm font-medium text-gray-500">Score de Risque de Burnout (100 = Risque Maximal pour Perte de Contr√¥le)</p>
                    <strong class="text-xl text-red-600">--</strong>
                </div>
            </div>

            <div class="ai-insight-box" id="ai-insight-container">
                <h4><span>üîé</span> Moteur de D√©couverte (IA)</h4>
                <p class="text-xs text-gray-500 -mt-2 mb-3">L'IA a scann√© vos donn√©es et a trouv√© les corr√©lations les plus fortes (R¬≤ > 0.25) :</p>
                <ul id="ai-insights-list">
                    </ul>
            </div>
            
            <div class="score-card score-low" id="dff-score">
                <span class="score-icon text-orange-600">üìâ</span>
                <div>
                    <p class="text-sm font-medium text-gray-500">Facteur de Tendance Globale (Pente / 10 devoirs)</p>
                    <strong class="text-xl text-orange-600">--</strong>
                </div>
            </div>
        </div>

        <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-700 border-t pt-3">Param√®tres Actuels</h3>
        <div class="space-y-3 mb-6 text-sm">
            <div>
                <label for="niveau-secondaire" class="block text-sm font-medium text-gray-700">Niveau Secondaire</label>
                <select id="niveau-secondaire" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm py-2 px-3 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">S√©lectionner</option>
                    <option value="sec4">Secondaire 4</option>
                    <option value="sec5">Secondaire 5</option>
                </select>
            </div>
            <div>
                <label class="slider-label block text-sm font-medium text-gray-700">Taux d'Absent√©isme/D√©sengagement</label>
                <input type="range" id="absence-rate-slider" min="0" max="25" step="0.5" value="5" class="w-full mt-1">
                <p class="text-xs text-gray-500 mt-1">Impact sur B-Risk : <span id="absence-rate-value">5.0%</span></p>
            </div>

            <div>
                <label for="unites-mode" class="block text-sm font-medium text-gray-700">Mode Unit√©s (Pond√©ration)</label>
                <div class="flex space-x-2">
                    <select id="unites-mode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm py-2 px-3 focus:ring-primary-500 focus:border-primary-500">
                        <option value="defaut">D√©faut (Officiel)</option>
                        <option value="sans">Sans Unit√©s (Moy. Simple)</option>
                        <option value="perso">Personnalis√©</option>
                    </select>
                    <button id="unites-btn" class="bg-gray-200 text-gray-600 rounded-md px-3 hover:bg-gray-300 transition duration-150 text-sm">√âditer</button>
                </div>
            </div>
        </div>

        <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-700 border-t pt-3">Moyennes par Mati√®re (<span id="active-etape-name">1</span>)</h3>
        <ul id="subject-averages-list" class="space-y-2 text-base">
            </ul>

    </div>

    <div class="content-area">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">D√©tails de Performance & Pr√©dictions</h1>

        <div class="flex border-b border-gray-200 mb-4">
            <button class="tab-btn active" data-tab="etape1">√âtape 1 - Analyse</button>
            <button class="tab-btn" data-tab="etape2">√âtape 2 - Analyse</button>
            <button class="tab-btn" data-tab="etape3">√âtape 3 - Projection</button>
            <button class="tab-btn" data-tab="simulation">Monte Carlo & Probabilit√©s</button>
        </div>

        <div id="tab-contents">
            <div id="etape1" class="tab-content active">
                </div>
            <div id="etape2" class="tab-content">
                </div>
            <div id="etape3" class="tab-content">
                </div>

            <div id="simulation" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-primary-color">Analyse Pr√©dictive Stochastique (100,000 Sc√©narios)</h2>
                <p class="text-gray-600 mb-6 border-b pb-4">
                    *Le mod√®le utilise la **R√©gression Lin√©aire** pour la tendance de base et projette la performance. Les probabilit√©s sont calcul√©es √† l'aide d'une **CDF Normale** bas√©e sur la tendance et la volatilit√© (StdDev) de vos notes. Ces donn√©es sont des estimations statistiques.*
                </p>

                <h3 class="text-xl font-semibold mb-3 mt-4 text-gray-700">Pr√©dictions de Moyenne Finale Globale (Intervalles de Confiance)</h3>
                <div id="global-predictions" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                    </div>

                <h3 class="text-xl font-semibold mb-3 mt-8 text-gray-700 border-t pt-4">Analyse de D√©s√©quilibre Volatilit√© / Effort (Mismatch)</h3>
                <div id="mismatch-analysis" class="space-y-4">
                    </div>

                <h3 class="text-xl font-semibold mb-3 mt-8 text-gray-700 border-t pt-4">Analyse de Chemin : Moyenne Requise √† l'√âtape 2</h3>
                <p class="text-sm text-gray-600 mb-4">Moyenne exacte que vous devez obtenir √† l'**√âtape 2** (bas√© sur E1 et la projection E3) pour atteindre chaque objectif global.</p>
                <table class="probability-table w-full rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-gray-100">
                            <th>Objectif Global (%)</th>
                            <th>Moyenne Requise E2 (%)</th>
                            <th>Probabilit√© (%)</th>
                            <th>Analyse du Risque</th>
                        </tr>
                    </thead>
                    <tbody id="probability-table-body-e2">
                        </tbody>
                </table>

                <h3 class="text-xl font-semibold mb-3 mt-8 text-gray-700 border-t pt-4">Analyse de Chemin : Moyenne Requise √† l'√âtape 3</h3>
                <p class="text-sm text-gray-600 mb-4">Moyenne exacte que vous devez obtenir √† l'**√âtape 3** (bas√© sur E1+E2) pour atteindre chaque objectif global.</p>
                <table class="probability-table w-full rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-gray-100">
                            <th>Objectif Global (%)</th>
                            <th>Moyenne Requise E3 (%)</th>
                            <th>Probabilit√© (%)</th>
                            <th>Analyse du Risque</th>
                        </tr>
                    </thead>
                    <tbody id="probability-table-body-e3">
                        </tbody>
                </table>

                 <h3 class="text-xl font-semibold mb-3 mt-8 text-gray-700 border-t pt-4">Pr√©dictions Tendancielles D√©taill√©es par Mati√®re</h3>
                <p class="text-sm text-gray-600 mb-4">Pr√©diction de note finale (E1+E2+E3) bas√©e sur la **Tendance par R√©gression Lin√©aire**. **Plafond√© au Max. Historique + 5%**.</p>
                <div id="subject-predictions-list" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>
</div>

<div id="unites-modal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4">Unit√©s par Mati√®re</h3>
        <p class="text-sm text-gray-500 mb-4">Ajustez les unit√©s pour chaque mati√®re si le mode 'Personnalis√©' est s√©lectionn√©.</p>
        <div id="unites-list" class="max-h-80 overflow-y-auto border p-3 rounded-md space-y-2">
            </div>
        <div class="mt-6 flex justify-end">
            <button id="close-unites-modal" class="bg-primary-color text-white px-4 py-2 rounded-md hover:bg-violet-700 transition">Fermer & Appliquer</button>
        </div>
    </div>
</div>

<script src="js/projected-averages.js"></script> 
<script src="js/projection.js"></script>

<script>
    // Inline script for instant theme loading
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;
    const toggleIcon = themeToggle.querySelector('i');
    const THEME_KEY = 'mbs-theme'; 

    const updateTheme = (theme) => {
        html.setAttribute('data-theme', theme);
        localStorage.setItem(THEME_KEY, theme);
        toggleIcon.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        
        // Fix for specific class that uses hardcoded Tailwind colors (e.g., text-violet-700)
        // This is a temporary JS fix for elements that need the primary color and have a static class.
        const elementsToUpdatePrimary = document.querySelectorAll('.text-violet-700');
        elementsToUpdatePrimary.forEach(el => {
            el.style.color = theme === 'dark' ? 'var(--primary-color)' : 'var(--primary-color)';
        });
    };

    const storedTheme = localStorage.getItem(THEME_KEY);
    // Use 'light' as a default if no system preference or stored theme exists
    const initialTheme = storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    updateTheme(initialTheme);

    themeToggle.addEventListener('click', () => {
        const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        updateTheme(newTheme);
    });
</script>

</body>
</html>
